USE DATABASE DB_IAWT_DEV_DWH;

--- Revenues BDV

CREATE OR REPLACE PROCEDURE REVENUES_BDV."REVENUE_IAS_COMMISSION_TO_BDV_WT_LINK_REVENUE"("ENV" VARCHAR(16777216), "IO_START_DATE" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE JAVASCRIPT
EXECUTE AS OWNER
AS '
 
INS_QUERY = "INSERT INTO db_IAWT_env_dwh.Revenues_bdv.WT_LINK_REVENUE (HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER, "+
"HK_HUB_PARTY_ROLE_ADVISOR, "+
"HK_HUB_CONTRACT, "+
"MD_START_DT, "+
"MD_SOURCE, "+
"MD_SRC_SYSTEM, "+
"MD_EXTRACT_DT, "+
"CLIENT_ID, "+
"CONTRACT_ID, "+
"ADVISOR_ID, "+
"MASTER_CODE, "+
"PLN_MNEM, "+
"MARKETPRODUCT_ID, "+
"PAYMENT_DATE, "+
"REVENUE, "+
"REVENUE_TYPE, "+
"REVENUE_SUBTYPE, "+
"AUA) "+
"(with t1 as (select   HK_HUB_PARTY_ROLE_ADVISOR as Link_Revenue_HK_HUB_PARTY_ROLE_ADVISOR, HK_HUB_CONTRACT	as Link_Revenue_HK_HUB_CONTRACT	,MD_SOURCE as  Link_Revenue_MD_SOURCE, "+
"MD_SRC_SYSTEM	as Link_Revenue_MD_SRC_SYSTEM,MD_EXTRACT_DT	as Link_Revenue_MD_EXTRACT_DT, ACCOUNTID as	Link_Revenue_ACCOUNTID, "+
"ADVISOR_ID as	Link_Revenue_ADVISOR_ID	, REPID as	Link_Revenue_REPID	, PROCESSDATE	Link_Revenue_PROCESSDATE,sum(REVENUE) as	Link_Revenue_O_REVENUE, "+
"MD_START_DT as Link_Revenue_MD_START_DT , SOURCECODE as Link_Revenue_SOURCECODE from "+
"db_IAWT_env_dwh.Revenues_rdv.LINK_REVENUE_RR_IAS_COMMISSION where MD_START_DT = TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_HUB_CONTRACT	, MD_START_DT , "+
"HK_HUB_PARTY_ROLE_ADVISOR, "+    
"MD_EXTRACT_DT	, "+
"MD_SOURCE, "+
"MD_SRC_SYSTEM, "+
"REPID	, "+
"ADVISOR_ID	, "+
"ACCOUNTID	, "+
"PROCESSDATE	, "+
"SOURCECODE ), t2 as "+
"(select "+
"HK_HUB_CONTRACT as VW_HK_HUB_CONTRACT ,HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER as	VW_HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER , "+
"A_C_CLIENT as 	VW_A_C_CLIENT from db_IAWT_env_dwh.shared_bdv.VW_CLIENT_CONTRACT as mstr join ( "+
"select HK_HUB_CONTRACT as dtls_hk_HUB_CONTRACT, max(md_start_dt) as max_start_dt from  db_IAWT_env_dwh.shared_bdv.VW_CLIENT_CONTRACT "+
"where MD_START_DT <= TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_HUB_CONTRACT ) as dtls "+
"on HK_HUB_CONTRACT = dtls_hk_HUB_CONTRACT where MD_ACTIVE = ''A''), "+
"t3 as (select * from t1 left outer join t2 on VW_HK_HUB_CONTRACT = Link_Revenue_HK_HUB_CONTRACT where Link_Revenue_SOURCECODE!=''EXP'' AND "+
"Link_Revenue_SOURCECODE!=''TXR'' AND Link_Revenue_REPID!= ''SEAA'' AND  Link_Revenue_REPID!= ''SEZ9'' "+
"AND Link_Revenue_REPID!= ''QYYY''), "+
"t4 as (select "+
"HK_Link as SAT_LINK_INVESTMENT_HK_LINK  from  db_IAWT_env_dwh.holdings_bdv.SAT_LINK_INVESTMENT as mstr join ( "+
"select HK_LINK as dtls_HK_LINK, max(md_start_dt) as max_start_dt from   db_IAWT_env_dwh.holdings_bdv.SAT_LINK_INVESTMENT "+
"where MD_START_DT <= TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_LINK ) as dtls "+
"on HK_LINK = dtls_hk_LINK where MD_ACTIVE = ''A''), "+
"t5 as (select "+
"AUA,HK_Link  as SAT_LINK_INVESTMENT_HK_LINK, md_src_system as Satlink_Investment_MD_SRC_SYSTEM  from  db_IAWT_env_dwh.holdings_bdv.SAT_LINK_INVESTMENT as mstr join ( "+
"select HK_LINK as dtls_HK_LINK, max(md_start_dt) as max_start_dt from   db_IAWT_env_dwh.holdings_bdv.SAT_LINK_INVESTMENT "+
"where MD_START_DT <= TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_LINK ) as dtls "+
"on HK_LINK = dtls_hk_LINK where MD_ACTIVE = ''A''), "+
"t6 as(select Link_Investment_CONTRACT_ID, link_investment_master_code,SUM(AUA) as SUM_AUA, "+
"link_investment_client_ID "+
"from t5 as master join (select HK_LINK as dtls_HK_LINK, contract_Id as link_investment_HK_HUB_contract, master_code as link_investment_master_code, "+
"HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER as Link_Investment_HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER, "+
"HK_HUB_PARTY_ROLE_ADVISOR as Link_Investment_HK_HUB_PARTY_ROLE_ADVISOR,CONTRACT_ID as Link_Investment_CONTRACT_ID, "+
"client_id as link_investment_client_ID  from db_IAWT_env_dwh.holdings_bdv.LINK_INVESTMENT) as dtls  on dtls_HK_LINK = SAT_LINK_INVESTMENT_HK_LINK "+
"group by "+
"Link_Investment_HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER	, "+
"Link_Investment_HK_HUB_PARTY_ROLE_ADVISOR	, "+
"Link_Investment_HK_HUB_CONTRACT	, "+
"Link_Investment_CONTRACT_ID	, "+
"Satlink_Investment_MD_SRC_SYSTEM, "+
"Link_Investment_MASTER_CODE	, "+
"Link_Investment_CLIENT_ID) "+
"select VW_HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER, "+
"Link_Revenue_HK_HUB_PARTY_ROLE_ADVISOR, "+
"Link_Revenue_HK_HUB_CONTRACT, "+
"TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') , "+
"Link_Revenue_MD_SOURCE, "+
"Link_Revenue_MD_SRC_SYSTEM, "+
"Link_Revenue_MD_EXTRACT_DT, "+
"VW_A_C_CLIENT, "+
"Link_Revenue_ACCOUNTID, "+
"Link_Revenue_ADVISOR_ID, "+
"Link_Revenue_REPID, "+
"-1, "+
"-1, "+
"Link_Revenue_PROCESSDATE, "+
"Link_Revenue_O_REVENUE , "+
"BUSINESS_RULES.UDF_CONV_BR_ALL_REVENUE_001(Link_Revenue_SOURCECODE)[''o_REVENUE_TYPE''], "+
"BUSINESS_RULES.UDF_CONV_BR_ALL_REVENUE_001(Link_Revenue_SOURCECODE)[''o_REVENUE_SUBTYPE''], "+
"SUM_AUA "+
"from t3 left outer join t6 on Link_Revenue_ACCOUNTID = Link_Investment_CONTRACT_ID and "+
"Link_Revenue_REPID	=	Link_Investment_MASTER_CODE and "+
"VW_A_C_CLIENT	=	Link_Investment_CLIENT_ID ) ";
var INS_QUERY_ENV = INS_QUERY.replaceAll("_env_","_"+ ENV + "_");
var sql_statement = snowflake.createStatement({
  sqlText: INS_QUERY_ENV
});
 var result_scan = sql_statement.execute(); 
';

CREATE OR REPLACE PROCEDURE REVENUES_BDV."SP_CONV_LOADBDV_RDV_REVENUE_PAYABLE_INVESTIA_TO_BDV_WT_LINK_REVENUE"("ENV" VARCHAR(16777216), "IO_START_DATE" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE JAVASCRIPT
EXECUTE AS OWNER
AS '
 
INS_QUERY = "insert into db_IAWT_dev_dwh.revenues_bdv.WT_LINK_REVENUE(HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER, "+
"HK_HUB_PARTY_ROLE_ADVISOR	, "+
"HK_HUB_INVESTMENT_PRODUCT_TYPE	, "+
"HK_HUB_CONTRACT	, "+
"MD_START_DT	, "+
"MD_SOURCE	, "+
"MD_SRC_SYSTEM	, "+
"MD_EXTRACT_DT	, "+
"CLIENT_ID	, "+
"CONTRACT_ID	, "+
"ADVISOR_ID	, "+
"MASTER_CODE	, "+
"MARKETPRODUCT_ID	, "+
"PAYMENT_DATE	, "+
"REVENUE	, "+
"REVENUE_TYPE	, "+
"REVENUE_SUBTYPE	, "+
"REVENUE_ID	, "+
"PLN_SYSID	) "+
"with t1 as (select HK_HUB_INVESTMENT_PRODUCT_TYPE as link_revenue_RR_HK_HUB_INVESTMENT_PRODUCT_TYPE, "+
"HK_HUB_CONTRACT as link_revenue_RR_HK_HUB_CONTRACT, "+
"dtls.MD_SOURCE as link_revenue_RR_MD_SOURCE, "+
"COM_PRODUCTION_CD as sat_link_revenue_COM_PRODUCTION_CD , "+
"dtls.MD_SRC_SYSTEM as link_revenue_RR_MD_SRC_SYSTEM , "+
"mstr.MD_SRC_SYSTEM as    sat_link_md_src_system, "+
"IVR_SYSID as link_revenue_RR_IVR_SYSID, "+
"IVD_SYSID as   link_revenue_RR_IVD_SYSID, "+
"PAY_SYSID as link_revenue_RR_PAY_SYSID , "+
"PLN_SYSID as link_revenue_RR_PLN_SYSID , "+
"mstr.MD_EXTRACT_DT as sat_link_revenue_MD_EXTRACT_DT, "+
"REP_SYSID as   sat_link_revenue_REP_SYSID, "+
"payment_dt as  link_revenue_rr_payment_dt, "+
"COM_PYBL as  sat_link_revenue_COM_BEN_PYBL, "+
"process_dt as  link_revenue_rr_process_dt "+
"from db_IAWT_dev_dwh.revenues_rdv.SAT_LINK_REVENUE_PAYABLE_RR_INVESTIA_UNIVERIS as mstr join db_IAWT_dev_dwh.revenues_rdv.LINK_REVENUE_RR as dtls on mstr.hk_link = dtls.hk_link "+
"where mstr.MD_START_DT = TO_DATE(''"+ IO_START_DATE + "'',''YYYY-MM-DD'') AND mstr.MD_ACTIVE = ''A''), "+
"t2 as(select max(slic.MD_START_DT) as md_max_start_dt,lic.hk_hub_contract as lic_hk_hub_contract from db_IAWT_dev_dwh.shared_rdv.SAT_LINK_INVESTMENT_CONTRACT_INVESTIA_UNIVERIS as slic join db_IAWT_dev_dwh.shared_rdv.LINK_INVESTMENT_CONTRACT_RR as lic  on slic.hk_link = lic.hk_link "+
"where slic.MD_START_DT <= TO_DATE(''"+ IO_START_DATE + "'',''YYYY-MM-DD'') and lic.md_src_system = ''INVESTIA-UNIVERIS'' group by lic.hk_hub_contract), "+
"t3 as(select  HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER as lic2_Inv_Contract_HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER,lic.hk_hub_contract as lic2_hk_hub_contract , "+
"CONTRACT_ID as LIHCPass2_CONTRACT_ID,slic.md_active as slic2_md_active from db_IAWT_dev_dwh.shared_rdv.SAT_LINK_INVESTMENT_CONTRACT_INVESTIA_UNIVERIS as slic join db_IAWT_dev_dwh.shared_rdv.LINK_INVESTMENT_CONTRACT_RR as lic  on slic.hk_link = lic.hk_link "+
"where slic.MD_START_DT <= TO_DATE(''"+ IO_START_DATE + "'',''YYYY-MM-DD'') and lic.md_src_system = ''INVESTIA-UNIVERIS'' ), "+
"t4 as (select * from t2 join t3 on lic_hk_hub_contract = lic2_hk_hub_contract where slic2_md_active = ''A''), "+
"t5 as (select * from t1 left outer join t4 on lic_hk_hub_contract = link_revenue_RR_HK_HUB_CONTRACT), "+
"t6 as (select "+
"HK_HUB as SAT_REGISTERED_HK_HUB,REP_SYSID as sat_REP_SYSID,md_active  from  db_IAWT_dev_dwh.shared_rdv.SAT_REGISTERED_REPRESENTATIVE_IAS_UNIVERIS as mstr join ( "+
"select HK_HUB as dtls_HK_HUB, max(md_start_dt) as max_start_dt from   db_IAWT_dev_dwh.shared_rdv.SAT_REGISTERED_REPRESENTATIVE_IAS_UNIVERIS "+
"where MD_START_DT <= TO_DATE(''"+ IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_HUB ) as dtls "+
"on HK_HUB = dtls_hk_HUB and MD_START_DT =  max_start_dt where MD_ACTIVE = ''A''), "+
"t7 as(  select * from t6 as master join (select HK_HUB as hub_hk_hub from  db_IAWT_dev_dwh.shared_rdv.HUB_REGISTERED_REPRESENTATIVE where MD_SRC_SYSTEM = ''INVESTIA-UNIVERIS'' "+
")  as dtls "+
"on SAT_REGISTERED_HK_HUB = hub_hk_hub where md_active = ''A''), "+
"t8 as(  select * from t5 left outer join t7 on sat_REP_SYSID = sat_link_revenue_REP_SYSID ), "+
"t9 as ( select MD_ACTIVE, "+
"HK_LINK as SAT_LINK_PARTY_RELATIONSHIP_HK_LINK,COMMISSIONPCT as sat_link_Commission_COMMISSIONPCT  from  db_IAWT_dev_dwh.shared_bdv.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE as mstr join ( "+
"select HK_LINK as dtls_HK_LINK, max(md_start_dt) as max_start_dt from   db_IAWT_dev_dwh.shared_bdv.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE "+
"where MD_START_DT <= TO_DATE(''"+ IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_LINK) as dtls "+
"on HK_LINK = dtls_hk_LINK and MD_START_DT =  max_start_dt where MD_ACTIVE = ''A''), "+
"t10 as(  select * from t9 as master join (select HK_LINK, HK_HUB_PARTY_ROLE_ADVISOR as link_Commission_HK_HUB_PARTY_ROLE_ADVISOR, MASTER_CODE as  link_Commission_MASTER_CODE, "+
"HK_HUB_REGISTERED_REPRESENTATIVE as link_Commission_HK_HUB_REGISTERED_REPRESENTATIVE,MD_SRC_SYSTEM "+
"from  db_IAWT_dev_dwh.shared_bdv.LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE where MD_SRC_SYSTEM = ''INVESTIA-UNIVERIS'' )  as dtls "+
"on SAT_LINK_PARTY_RELATIONSHIP_HK_LINK = HK_LINK where MD_SRC_SYSTEM = ''INVESTIA-UNIVERIS'' and MD_ACTIVE = ''A'' ), "+
"t11 as(select * from t8 left outer join t10 on  hub_hk_hub = link_Commission_HK_HUB_REGISTERED_REPRESENTATIVE ), "+
"t12 as ( select hk_HUB as SAT_prod_HK_HUB,COM_PRODUCTION_MNEM,COM_PRODUCTION_LONG_DESC from  db_IAWT_dev_dwh.revenues_rdv.SAT_REF_COM_PRODUCTION_INVESTIA_UNIVERIS as mstr join ( "+
"select HK_HUB as dtls_HK_HUB, max(md_start_dt) as max_start_dt from  db_IAWT_dev_dwh.revenues_rdv.SAT_REF_COM_PRODUCTION_INVESTIA_UNIVERIS "+
"where MD_START_DT <= TO_DATE(''"+ IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_HUB) as dtls "+
"on HK_HUB = dtls_hk_HUB and MD_START_DT =  max_start_dt where MD_ACTIVE = ''A''), "+
"t13 as (select * from t12 join (select * "+
"from db_IAWT_dev_dwh.revenues_rdv.REF_COM_PRODUCTION) on hk_HUB = SAT_prod_HK_HUB ) "+
"select lic2_Inv_Contract_HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER, "+
"link_Commission_HK_HUB_PARTY_ROLE_ADVISOR, "+
"link_revenue_RR_HK_HUB_INVESTMENT_PRODUCT_TYPE, "+
"link_revenue_RR_HK_HUB_CONTRACT, "+
"TO_DATE(''"+ IO_START_DATE + "'',''YYYY-MM-DD''), "+
"link_revenue_RR_MD_SOURCE, "+
"link_revenue_RR_MD_SRC_SYSTEM, "+
"sat_link_revenue_MD_EXTRACT_DT, "+
"link_revenue_RR_IVR_SYSID, "+
"LIHCPass2_CONTRACT_ID, "+
"link_Commission_MASTER_CODE, "+
"link_Commission_MASTER_CODE, "+
"link_revenue_RR_IVD_SYSID, "+
"link_revenue_RR_PAYMENT_DT, "+
"sat_link_revenue_COM_BEN_PYBL * IFF(sat_link_Commission_COMMISSIONPCT IS NULL,100,sat_link_Commission_COMMISSIONPCT) * 0.01, "+
"BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_REVENUE_REVENUE_TYPE_002(sat_link_revenue_com_production_cd,sat_link_md_src_system), "+
"BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_REVENUE_REVENUE_SUBTYPE_003(COM_PRODUCTION_MNEM,COM_PRODUCTION_LONG_DESC), "+
"link_revenue_RR_PLN_SYSID, "+
"link_revenue_RR_PAY_SYSID "+
"from t11 left outer join t13 on sat_link_revenue_COM_PRODUCTION_CD = COM_PRODUCTION_CD "+
"where  sat_link_revenue_COM_PRODUCTION_CD in(''02'',''20'',''21'',''22'',''23'',''24'',''25'',''26'') ";
var INS_QUERY_ENV = INS_QUERY.replaceAll("_dev_","_"+ ENV + "_");
var sql_statement = snowflake.createStatement({
  sqlText: INS_QUERY_ENV
});
 var result_scan = sql_statement.execute(); 
';

CREATE OR REPLACE PROCEDURE "SP_CONV_LOADBDV_RDV_REVENUE_IAS_COMMISSION_TO_BDV_WT_LINK_REVENUE"("ENV" VARCHAR(16777216), "IO_START_DATE" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE JAVASCRIPT
EXECUTE AS OWNER
AS '
 
INS_QUERY = "INSERT INTO db_IAWT_env_dwh.Revenues_bdv.WT_LINK_REVENUE (HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER, "+
"HK_HUB_PARTY_ROLE_ADVISOR, "+
"HK_HUB_CONTRACT, "+
"MD_START_DT, "+
"MD_SOURCE, "+
"MD_SRC_SYSTEM, "+
"MD_EXTRACT_DT, "+
"CLIENT_ID, "+
"CONTRACT_ID, "+
"ADVISOR_ID, "+
"MASTER_CODE, "+
"PLN_MNEM, "+
"MARKETPRODUCT_ID, "+
"PAYMENT_DATE, "+
"REVENUE, "+
"REVENUE_TYPE, "+
"REVENUE_SUBTYPE, "+
"AUA) "+
"(with t1 as (select   HK_HUB_PARTY_ROLE_ADVISOR as Link_Revenue_HK_HUB_PARTY_ROLE_ADVISOR, HK_HUB_CONTRACT	as Link_Revenue_HK_HUB_CONTRACT	,MD_SOURCE as  Link_Revenue_MD_SOURCE, "+
"MD_SRC_SYSTEM	as Link_Revenue_MD_SRC_SYSTEM,MD_EXTRACT_DT	as Link_Revenue_MD_EXTRACT_DT, ACCOUNTID as	Link_Revenue_ACCOUNTID, "+
"ADVISOR_ID as	Link_Revenue_ADVISOR_ID	, REPID as	Link_Revenue_REPID	, PROCESSDATE	Link_Revenue_PROCESSDATE,sum(REVENUE) as	Link_Revenue_O_REVENUE, "+
"MD_START_DT as Link_Revenue_MD_START_DT , SOURCECODE as Link_Revenue_SOURCECODE from "+
"db_IAWT_env_dwh.Revenues_rdv.LINK_REVENUE_RR_IAS_COMMISSION where MD_START_DT = TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_HUB_CONTRACT	, MD_START_DT , "+
"HK_HUB_PARTY_ROLE_ADVISOR, "+    
"MD_EXTRACT_DT	, "+
"MD_SOURCE, "+
"MD_SRC_SYSTEM, "+
"REPID	, "+
"ADVISOR_ID	, "+
"ACCOUNTID	, "+
"PROCESSDATE	, "+
"SOURCECODE ), t2 as "+
"(select "+
"HK_HUB_CONTRACT as VW_HK_HUB_CONTRACT ,HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER as	VW_HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER , "+
"A_C_CLIENT as 	VW_A_C_CLIENT from db_IAWT_env_dwh.shared_bdv.VW_CLIENT_CONTRACT as mstr join ( "+
"select HK_HUB_CONTRACT as dtls_hk_HUB_CONTRACT, max(md_start_dt) as max_start_dt from  db_IAWT_env_dwh.shared_bdv.VW_CLIENT_CONTRACT "+
"where MD_START_DT <= TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_HUB_CONTRACT ) as dtls "+
"on HK_HUB_CONTRACT = dtls_hk_HUB_CONTRACT where MD_ACTIVE = ''A''), "+
"t3 as (select * from t1 left outer join t2 on VW_HK_HUB_CONTRACT = Link_Revenue_HK_HUB_CONTRACT where Link_Revenue_SOURCECODE!=''EXP'' AND "+
"Link_Revenue_SOURCECODE!=''TXR'' AND Link_Revenue_REPID!= ''SEAA'' AND  Link_Revenue_REPID!= ''SEZ9'' "+
"AND Link_Revenue_REPID!= ''QYYY''), "+
"t4 as (select "+
"HK_Link as SAT_LINK_INVESTMENT_HK_LINK  from  db_IAWT_env_dwh.holdings_bdv.SAT_LINK_INVESTMENT as mstr join ( "+
"select HK_LINK as dtls_HK_LINK, max(md_start_dt) as max_start_dt from   db_IAWT_env_dwh.holdings_bdv.SAT_LINK_INVESTMENT "+
"where MD_START_DT <= TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_LINK ) as dtls "+
"on HK_LINK = dtls_hk_LINK where MD_ACTIVE = ''A''), "+
"t5 as (select "+
"AUA,HK_Link  as SAT_LINK_INVESTMENT_HK_LINK, md_src_system as Satlink_Investment_MD_SRC_SYSTEM  from  db_IAWT_env_dwh.holdings_bdv.SAT_LINK_INVESTMENT as mstr join ( "+
"select HK_LINK as dtls_HK_LINK, max(md_start_dt) as max_start_dt from   db_IAWT_env_dwh.holdings_bdv.SAT_LINK_INVESTMENT "+
"where MD_START_DT <= TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_LINK ) as dtls "+
"on HK_LINK = dtls_hk_LINK where MD_ACTIVE = ''A''), "+
"t6 as(select Link_Investment_CONTRACT_ID, link_investment_master_code,SUM(AUA) as SUM_AUA, "+
"link_investment_client_ID "+
"from t5 as master join (select HK_LINK as dtls_HK_LINK, contract_Id as link_investment_HK_HUB_contract, master_code as link_investment_master_code, "+
"HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER as Link_Investment_HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER, "+
"HK_HUB_PARTY_ROLE_ADVISOR as Link_Investment_HK_HUB_PARTY_ROLE_ADVISOR,CONTRACT_ID as Link_Investment_CONTRACT_ID, "+
"client_id as link_investment_client_ID  from db_IAWT_env_dwh.holdings_bdv.LINK_INVESTMENT) as dtls  on dtls_HK_LINK = SAT_LINK_INVESTMENT_HK_LINK "+
"group by "+
"Link_Investment_HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER	, "+
"Link_Investment_HK_HUB_PARTY_ROLE_ADVISOR	, "+
"Link_Investment_HK_HUB_CONTRACT	, "+
"Link_Investment_CONTRACT_ID	, "+
"Satlink_Investment_MD_SRC_SYSTEM, "+
"Link_Investment_MASTER_CODE	, "+
"Link_Investment_CLIENT_ID) "+
"select VW_HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER, "+
"Link_Revenue_HK_HUB_PARTY_ROLE_ADVISOR, "+
"Link_Revenue_HK_HUB_CONTRACT, "+
"TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') , "+
"Link_Revenue_MD_SOURCE, "+
"Link_Revenue_MD_SRC_SYSTEM, "+
"Link_Revenue_MD_EXTRACT_DT, "+
"VW_A_C_CLIENT, "+
"Link_Revenue_ACCOUNTID, "+
"Link_Revenue_ADVISOR_ID, "+
"Link_Revenue_REPID, "+
"-1, "+
"-1, "+
"Link_Revenue_PROCESSDATE, "+
"Link_Revenue_O_REVENUE , "+
"BUSINESS_RULES.REVENUES.UDF_CONV_BR_ALL_REVENUE_001(Link_Revenue_SOURCECODE)[''o_REVENUE_TYPE''], "+
"BUSINESS_RULES.REVENUES.UDF_CONV_BR_ALL_REVENUE_001(Link_Revenue_SOURCECODE)[''o_REVENUE_SUBTYPE''], "+
"SUM_AUA "+
"from t3 left outer join t6 on Link_Revenue_ACCOUNTID = Link_Investment_CONTRACT_ID and "+
"Link_Revenue_REPID	=	Link_Investment_MASTER_CODE and "+
"VW_A_C_CLIENT	=	Link_Investment_CLIENT_ID ) ";
var INS_QUERY_ENV = INS_QUERY.replaceAll("_env_","_"+ ENV + "_");
var sql_statement = snowflake.createStatement({
  sqlText: INS_QUERY_ENV
});
 var result_scan = sql_statement.execute(); 
';

CREATE OR REPLACE PROCEDURE REVENUES_BDV."SP_CONV_LOADBDV_RDV_REVENUE_PAYABLE_IAS_UNIVERIS_TO_BDV_WT_LINK_REVENUE"("ENV" VARCHAR(16777216), "IO_START_DATE" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE JAVASCRIPT
EXECUTE AS OWNER
AS '
 
INS_QUERY = "insert into db_IAWT_dev_dwh.revenues_bdv.WT_LINK_REVENUE(HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER, "+
"HK_HUB_PARTY_ROLE_ADVISOR	, "+
"HK_HUB_REF_INVESTMENT_SAVING_PROGRAM_TYPES, "+
"HK_HUB_INVESTMENT_PRODUCT_TYPE	, "+
"HK_HUB_CONTRACT	, "+
"MD_START_DT	, "+
"MD_SOURCE	, "+
"MD_SRC_SYSTEM	, "+
"MD_EXTRACT_DT	, "+
"CLIENT_ID	, "+
"CONTRACT_ID	, "+
"ADVISOR_ID	, "+
"MASTER_CODE	, "+
"PLN_MNEM	, "+
"MARKETPRODUCT_ID	, "+
"PAYMENT_DATE	, "+
"REVENUE	, "+
"REVENUE_TYPE	, "+
"REVENUE_SUBTYPE	, "+
"REVENUE_ID	, "+
"PLN_SYSID	) "+
"(with t1 as(select HK_HUB_INVESTMENT_PRODUCT_TYPE as link_revenue_RR_HK_HUB_INVESTMENT_PRODUCT_TYPE, "+
"HK_HUB_CONTRACT as link_revenue_RR_HK_HUB_CONTRACT, "+
"dtls.MD_SOURCE as link_revenue_RR_MD_SOURCE, "+
"dtls.MD_SRC_SYSTEM as link_revenue_RR_MD_SRC_SYSTEM , "+
"mstr.MD_SRC_SYSTEM as    sat_link_md_src_system, "+
"IVR_SYSID as link_revenue_RR_IVR_SYSID, "+
"IVD_SYSID as   link_revenue_RR_IVD_SYSID, "+
"PAY_SYSID as link_revenue_RR_PAY_SYSID , "+
"PLN_SYSID as link_revenue_RR_PLN_SYSID , "+
"mstr.MD_EXTRACT_DT as sat_link_revenue_MD_EXTRACT_DT, "+
"REP_SYSID as   sat_link_revenue_REP_SYSID, "+
"COM_PRODUCTION_CD as  sat_link_revenue_COM_PRODUCTION_CD , "+
"payment_dt as  link_revenue_rr_payment_dt, "+
"process_dt as  link_revenue_rr_process_dt , "+
"COM_BEN_PYBL as  sat_link_revenue_COM_BEN_PYBL "+
"from db_IAWT_dev_dwh.revenues_rdv.SAT_LINK_REVENUE_PAYABLE_RR_IAS_UNIVERIS as mstr join db_IAWT_dev_dwh.revenues_rdv.LINK_REVENUE_RR as dtls on mstr.hk_link = dtls.hk_link), "+
"t2 as(select * from t1 left outer join (select HK_HUB_CONTRACT, HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER,contract_id from db_IAWT_dev_dwh.shared_rdv.LINK_INVESTMENT_CONTRACT_RR ) as dtls "+
"on HK_HUB_CONTRACT = link_revenue_RR_HK_HUB_CONTRACT), "+
"t3 as (select "+
"HK_HUB as SAT_REGISTERED_HK_HUB,REP_SYSID as sat_REP_SYSID  from  db_IAWT_dev_dwh.shared_rdv.SAT_REGISTERED_REPRESENTATIVE_IAS_UNIVERIS as mstr join ( "+
"select HK_HUB as dtls_HK_HUB, max(md_start_dt) as max_start_dt from   db_IAWT_dev_dwh.shared_rdv.SAT_REGISTERED_REPRESENTATIVE_IAS_UNIVERIS "+
"where MD_START_DT <= TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_HUB ) as dtls "+
"on HK_HUB = dtls_hk_HUB and MD_START_DT =  max_start_dt where MD_ACTIVE = ''A''), "+
"t4 as(  select * from t3 as master join (select HK_HUB as hub_hk_hub from  db_IAWT_dev_dwh.shared_rdv.HUB_REGISTERED_REPRESENTATIVE where CONTAINS(MD_SRC_SYSTEM, ''IAS'') ) as dtls "+
"on SAT_REGISTERED_HK_HUB = hub_hk_hub), "+
"t5 as(  select * from t2 left outer join t4 on sat_REP_SYSID = sat_link_revenue_REP_SYSID ), "+
"t6 as ( select "+
"HK_LINK as SAT_LINK_PARTY_RELATIONSHIP_HK_LINK,COMMISSIONPCT as sat_link_Commission_COMMISSIONPCT  from  db_IAWT_dev_dwh.shared_bdv.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE as mstr join ( "+
"select HK_LINK as dtls_HK_LINK, max(md_start_dt) as max_start_dt from   db_IAWT_dev_dwh.shared_bdv.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE "+
"where MD_START_DT <= TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_LINK) as dtls "+
"on HK_LINK = dtls_hk_LINK and MD_START_DT =  max_start_dt where MD_ACTIVE = ''A''), "+
"t7 as(  select * from t6 as master join (select HK_LINK, HK_HUB_PARTY_ROLE_ADVISOR as link_Commission_HK_HUB_PARTY_ROLE_ADVISOR, MASTER_CODE as  link_Commission_MASTER_CODE, "+
"HK_HUB_REGISTERED_REPRESENTATIVE as link_Commission_HK_HUB_REGISTERED_REPRESENTATIVE "+
"from  db_IAWT_dev_dwh.shared_bdv.LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE where CONTAINS(MD_SRC_SYSTEM, ''IAS'') ) as dtls "+
"on SAT_LINK_PARTY_RELATIONSHIP_HK_LINK = HK_LINK), "+
"t8 as(select * from t5 left outer join t7 on  hub_hk_hub = link_Commission_HK_HUB_REGISTERED_REPRESENTATIVE), "+
"t9 as (select "+
"HK_HUB as SAT_LINK_PARTY_RELATIONSHIP_HK_HUB,COM_PRODUCTION_MNEM,COM_PRODUCTION_LONG_DESC  from  db_IAWT_dev_dwh.revenues_rdv.SAT_REF_COM_PRODUCTION as mstr join ( "+
"select HK_hub as dtls_HK_hub, max(md_start_dt) as max_start_dt from  db_IAWT_dev_dwh.revenues_rdv.SAT_REF_COM_PRODUCTION "+
"where MD_START_DT <= TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD'') group by HK_HUB) as dtls "+
"on SAT_LINK_PARTY_RELATIONSHIP_HK_HUB = dtls_hk_hub and MD_START_DT =  max_start_dt where MD_ACTIVE = ''A''), "+
"t10 as (select * from t9 join (select HK_HUB,COM_PRODUCTION_CD as Ref_com_prod_COM_PRODUCTION_CD from "+
"db_IAWT_dev_dwh.revenues_rdv.REF_COM_PRODUCTION) as dtls on SAT_LINK_PARTY_RELATIONSHIP_HK_HUB = HK_HUB), "+
"t11 as (select * from t8 left outer join t10 on Ref_com_prod_COM_PRODUCTION_CD = sat_link_revenue_COM_PRODUCTION_CD ) "+
"select HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER, "+
"link_Commission_HK_HUB_PARTY_ROLE_ADVISOR, "+
"Link_Invstment_cnt_HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES, "+
"link_revenue_RR_HK_HUB_INVESTMENT_PRODUCT_TYPE, "+
"link_revenue_RR_HK_HUB_CONTRACT, "+
"TO_DATE(''" + IO_START_DATE + "'',''YYYY-MM-DD''), "+
"link_revenue_RR_MD_SOURCE, "+
"link_revenue_RR_MD_SRC_SYSTEM, "+
"sat_link_revenue_MD_EXTRACT_DT, "+
"link_revenue_RR_IVR_SYSID, "+
"CONTRACT_ID	, "+
"link_Commission_MASTER_CODE, "+
"link_Commission_MASTER_CODE	, "+
"link_Invstment_cnt_PLN_MNEM	, "+
"link_revenue_RR_IVD_SYSID, "+
"IFF(link_revenue_rr_payment_dt is NULL, link_revenue_rr_payment_dt, link_revenue_rr_process_dt), "+
"sat_link_revenue_COM_BEN_PYBL * IFF(sat_link_Commission_COMMISSIONPCT IS NULL,100,sat_link_Commission_COMMISSIONPCT) * 0.01	 , "+
"BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_REVENUE_REVENUE_TYPE_002(sat_link_revenue_com_production_cd,sat_link_md_src_system), "+
"BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_REVENUE_REVENUE_SUBTYPE_003(COM_PRODUCTION_MNEM,COM_PRODUCTION_LONG_DESC), "+
"link_revenue_RR_PAY_SYSID, "+
"link_revenue_RR_PLN_SYSID from t11 join (select HK_HUB_PARTY_ROLE_ADVISOR as Link_Invstment_cnt_HK_HUB_PARTY_ROLE_ADVISOR,  PLN_MNEM as Link_Invstment_cnt_PLN_MNEM, "+
"HK_HUB_CONTRACT as Link_Invstment_cnt_HK_HUB_CONTRACT,HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES as Link_Invstment_cnt_HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES "+
"from   db_IAWT_dev_dwh.shared_bdv.LINK_INVESTMENT_CONTRACT where md_src_system = ''INVESTIA-UNIVERIS'') "+
"on Link_Invstment_cnt_HK_HUB_PARTY_ROLE_ADVISOR = link_Commission_HK_HUB_PARTY_ROLE_ADVISOR  and "+
"Link_Invstment_cnt_HK_HUB_CONTRACT = link_revenue_RR_HK_HUB_CONTRACT "+
"where NOT sat_link_revenue_COM_PRODUCTION_CD in(''02'',''20'',''21'',''22'',''23'',''24'',''25'',''26'') ) ";
var INS_QUERY_ENV = INS_QUERY.replaceAll("_dev_","_"+ ENV + "_");
var sql_statement = snowflake.createStatement({
  sqlText: INS_QUERY_ENV
});
 var result_scan = sql_statement.execute(); 
';

--- Shared BDV

CREATE OR REPLACE PROCEDURE SHARED_BDV."SP_CONV_LOADBDV_RDV_SHARED_TO_WT_SATACCOUNTHOLDER_COMPUTE"("ENV" VARCHAR(1000), "I_DATA_START_DATE" VARCHAR(1000))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
INS_PRE_DEL STRING;
INS_INSERT STRING;
INS_UPDATE STRING;
BEGIN
i_DATA_START_DATE :=CHAR(39)||i_DATA_START_DATE||CHAR(39);
INS_PRE_DEL := ''DELETE FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_COMPUTE WHERE MD_SRC_SYSTEM = ''''IAS'''' OR MD_SRC_SYSTEM= ''''NA'''' '';
INS_INSERT := ''
INSERT INTO DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_COMPUTE (HK_HUB,MD_START_DT,MD_CREATION_DT,MD_SOURCE,MD_SRC_SYSTEM,MD_EXTRACT_DT,INCOME_AMT,INCOME_LEVEL_1_SEGMENT,INCOME_LEVEL_1_SEGMENT_ORD,INCOME_LEVEL_2_SEGMENT,INCOME_LEVEL_2_SEGMENT_ORD,AGE_SEGMENT,AGE_SEGMENT_ORD,NEW_CLIENT_IND,CLIENT_START_DT)
SELECT rdv.HK_HUB
	,TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')
	,CURRENT_TIMESTAMP
	,rdv.MD_SOURCE
	,rdv.MD_SRC_SYSTEM
	,rdv.MD_EXTRACT_DT
	,clean.CLIENT_ANNUAL_GROSS_INC_CLEAN
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENTS_002(clean.CLIENT_ANNUAL_GROSS_INC_CLEAN)[''''o_INCOME_LEVEL_1_SEGMENT'''']
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENTS_002(clean.CLIENT_ANNUAL_GROSS_INC_CLEAN)[''''o_INCOME_LEVEL_1_SEGMENT_ORD'''']
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENTS_001(clean.CLIENT_ANNUAL_GROSS_INC_CLEAN)[''''o_INCOME_LEVEL_2_SEGMENT'''']
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENTS_001(clean.CLIENT_ANNUAL_GROSS_INC_CLEAN)[''''o_INCOME_LEVEL_2_SEGMENT_ORD'''']
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENTS_003(rdv.CLIENT_BIRTH_DATE, rdv.MD_START_DT,(CASE WHEN rdv.CLIENT_TAX_RECIP_TYPE IN (''''0'''',''''3'''',''''4'''',''''5'''') THEN ''''True'''' ELSE ''''False'''' END))[''''o_AGE_SEGMENT'''']
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENTS_003(rdv.CLIENT_BIRTH_DATE, rdv.MD_START_DT,(CASE WHEN rdv.CLIENT_TAX_RECIP_TYPE IN (''''0'''',''''3'''',''''4'''',''''5'''') THEN ''''True'''' ELSE ''''False'''' END))[''''o_AGE_SEGMENT_ORD'''']
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENTS_004(rdv.MD_START_DT, rdv.CLIENT_INIT_CONTRACT_DATE)
	,(SELECT MIN(A_C_OPEN_DATE) MIN_OPEN_DT FROM ( SELECT rdv2.* FROM ( SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_CONTRACT_IAS_NBIN ) rdv2 LEFT JOIN ( SELECT * FROM ( SELECT * ,ROW_NUMBER() OVER ( PARTITION BY HK_HUB ORDER BY MD_START_DT DESC ) RN FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_CONTRACT_IAS_NBIN lv2 ) SATHUB WHERE SATHUB.RN = 1 ) lv2 ON lv2.HK_HUB = rdv2.HK_HUB WHERE rdv2.MD_ACTIVE = ''''A'''' )) MIN_A_C_OPEN_DT
	FROM (
		SELECT *
		FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_PARTY_ROLE_ACCOUNT_HOLDER_IAS_NBIN
		) rdv
		JOIN (
		SELECT *
		FROM (
			SELECT *
				,ROW_NUMBER() OVER (
					PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
					) RN
			FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_PARTY_ROLE_ACCOUNT_HOLDER_IAS_NBIN lv
			) SATHUB
		WHERE SATHUB.RN = 1
		) lv ON lv.HK_HUB = rdv.HK_HUB AND rdv.MD_ACTIVE=''''A'''' AND lv.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
	JOIN DB_IAWT_''||ENV||''_DWH.SHARED_RDV.HUB_PARTY_ROLE_ACCOUNT_HOLDER lv1 ON lv1.HK_HUB = rdv.HK_HUB
	LEFT JOIN DB_IAWT_''||ENV||''_DWH.SHARED_BDV.VW_PARTY_ROLE_ACCOUNT_HOLDER_CLEAN clean ON clean.HK_HUB = rdv.HK_HUB AND clean.MD_START_DT = rdv.MD_START_DT AND clean.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
	LEFT JOIN (
		SELECT rdv2.*
		FROM (
			SELECT *
			FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_CONTRACT_IAS_NBIN
			) rdv2
			JOIN (
			SELECT *
			FROM (
				SELECT *
					,ROW_NUMBER() OVER (
						PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
						) RN1
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_CONTRACT_IAS_NBIN lv2
				) SATHUB1
			WHERE SATHUB1.RN1 = 1
			) lv2 ON lv2.HK_HUB = rdv2.HK_HUB AND rdv2.MD_ACTIVE = ''''A'''' AND lv2.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
		) lv3 ON lv3.A_C_CLIENT = lv1.CLIENT_ID	
              '';
INS_UPDATE :=''UPDATE SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_COMPUTE
SET
	MD_HASHDIFF=SHA1(
				CONCAT(
				COALESCE(TO_VARCHAR(INCOME_AMT),''''#NULL#''''), ''''|'''',
				COALESCE(INCOME_LEVEL_1_SEGMENT,''''#NULL#''''), ''''|'''',
				COALESCE(TO_VARCHAR(INCOME_LEVEL_1_SEGMENT_ORD),''''#NULL#''''), ''''|'''',
				COALESCE(INCOME_LEVEL_2_SEGMENT,''''#NULL#''''), ''''|'''',
				COALESCE(TO_VARCHAR(INCOME_LEVEL_2_SEGMENT_ORD),''''#NULL#''''), ''''|'''',
								COALESCE(AGE_SEGMENT,''''#NULL#''''), ''''|'''',
				COALESCE(TO_VARCHAR(AGE_SEGMENT_ORD),''''#NULL#''''), ''''|'''',
				COALESCE(NEW_CLIENT_IND,''''#NULL#''''), ''''|'''',
				COALESCE(TO_VARCHAR(CLIENT_START_DT),''''#NULL#'''')
				))
Where HK_HUB <> ''''0'''' AND MD_SRC_SYSTEM = ''''IAS''''
'';
EXECUTE IMMEDIATE :INS_PRE_DEL;
EXECUTE IMMEDIATE :INS_INSERT;
EXECUTE IMMEDIATE :INS_UPDATE;
END
';

CREATE OR REPLACE PROCEDURE SHARED_BDV."SP_CONV_LOADBDV_RDV_SAT_REGISTERED_REPRESENTATIVE_TO_BDV_WT_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH"("ENV" VARCHAR(1000), "I_DATA_START_DATE" VARCHAR(1000))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
INS_PRE_DEL STRING;
INS_INSERT STRING;
INS_UPDATE STRING;

BEGIN
i_DATA_START_DATE :=CHAR(39)||i_DATA_START_DATE||CHAR(39);
INS_PRE_DEL := ''DELETE FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH WHERE MD_SRC_SYSTEM = ''''IAS''''; '';
INS_INSERT := ''
INSERT INTO DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH
(
HK_HUB
,MD_START_DT
,MD_EXTRACT_DT
,MD_CREATION_DT
,MD_SOURCE
,MD_SRC_SYSTEM
,MASTER_CODE
,COMPANY_CODE
,COMPANY_NAME
,REGULATORY_ORGANIZATION_NAME
,REGULATORY_ORGANIZATION_CODE
,DEALER_NAME
,REGION_VP
,BRANCHCODE
,BRANCHNAME
,TEAM_CODE
,TEAM_NAME
,ADVISOR_FULLNAME
,FIRSTNAME
,LASTNAME
,STATUS
,PROVINCE_CODE
,ADVISOR_START_DATE
,NEW_ADVISOR
,DEPARTED_ADVISOR_IND
,PRIMARY_ROLE
,END_DATE
,REASON
,NEW_FIRM
,NEW_FIRM_TYPE
,NEW_FIRM_BACK_OFFICE
,PRESTIGE_STATUS
,TRANSITION_PERIOD_END_DATE
,DEAL_ASSESTS
,EXPECTED_ASSESTS
,PREVIOUS_FIRM
,PREVIOUS_FIRM_TYPE
,AGE_SEGMENT
,AGE_SEGMENT_ORD
--,MD_ACTIVE_CERTS
)

SELECT 
HK_HUB_PARTY_ROLE_ADVISOR
,O_MD_START_DT
,O_EXTRACT_DT
,O_MD_CREATION_DT
,O_MD_SOURCE
,O_MD_src_system
,LINK_MASTER_CODE
,O_Company_Code
,O_Company_Name
,O_Regulatory_Organization_Name
,O_Regulatory_Organization_Code
,O_Dealer_Name
,O_Regional_VP
,O_BRANCH_CODE
,O_BRANCH_NAME
,O_TEAM_CODE
,O_Team_Name
,Advisor_fullname
,O_FIRST_NAME
,O_LAST_NAME
,O_Status
,O_province_code
,MAX(BEGIN_DT)
,MAX(O_NEW_ADVISOR_IND)
,O_departed_advisor_ind
,MAX(O_primary_role)
,END_DATE
,REASON
,NEW_FIRM
,NEW_FIRM_TYPE
,NEW_FIRM_BACK_OFFICE
,PRESTIGE_STATUS
,TRANSITION_PERIOD_END_DATE
,DEAL_ASSESTS
,EXPECTED_ASSESTS
,PREVIOUS_FIRM
,PREVIOUS_FIRM_TYPE
,O_AGE_SEGMENT
,O_AGE_SEGMENT_ORD
--,MAX(O_md_active_certs)
FROM 
(
SELECT
''''Wealth'''' AS O_COMPANY_CODE
,''''iA Wealth Management'''' AS O_COMPANY_NAME
,''''IIROC'''' AS O_REGULATORY_ORGANIZATION_CODE
,''''Investment Industry Regulatory Organization of Canada'''' AS O_REGULATORY_ORGANIZATION_NAME
,''''iA Securities'''' AS O_DEALER_NAME
,CASE WHEN RDV_BDV.ACTIVEIND IS NULL OR RDV_BDV.ACTIVEIND = 0 THEN ''''Inactive'''' WHEN RDV_BDV.ACTIVEIND = 1 THEN ''''Active'''' END AS O_STATUS
,RDV_BDV.O_RR_CD AS OUTPUT_RR_CD
,CURRENT_TIMESTAMP AS O_MD_CREATION_DT
,''''IAS'''' AS O_MD_SRC_SYSTEM
,RDV_BDV.SAT_LINKCV_MD_EXTRACT_DT AS O_EXTRACT_DT
,RDV_BDV.SAT_LINKCV_MD_SOURCE AS O_MD_SOURCE
,TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''') AS O_MD_START_DT
,CASE WHEN RTrim(LTrim(RDV_BDV.Region_VP)) IS NOT NULL THEN RTrim(LTrim(RDV_BDV.Region_VP)) ELSE ''''non affiliated to RVPs'''' END AS O_REGIONAL_VP
,CASE WHEN RDV_BDV.TEAMNAME IS NULL THEN (CASE WHEN RDV_BDV.TEAM IS NULL THEN '''''''' ELSE RDV_BDV.TEAM END ) ELSE  RDV_BDV.TEAMNAME END AS O_TEAM_NAME
,CASE WHEN RDV_BDV.PROVINCE IS NULL THEN ''''N/A'''' WHEN RDV_BDV.PROVINCE = ''''#N/A'''' THEN ''''N/A'''' ELSE RDV_BDV.PROVINCE END O_PROVINCE_CODE
,CASE WHEN RDV_BDV.BRANCHCODE IS NOT NULL THEN RDV_BDV.BRANCHCODE WHEN RTrim(LTrim(RDV_BDV.BRN_CD)) IS NOT NULL THEN RTrim(LTrim(RDV_BDV.BRN_CD)) ELSE '''''''' END AS O_BRANCH_CODE
,CASE WHEN RDV_BDV.BRANCHNAME IS NOT NULL THEN RDV_BDV.BRANCHNAME WHEN RTrim(LTrim(RDV_BDV.BRN_NAME)) IS NOT NULL THEN RTrim(LTrim(RDV_BDV.BRN_NAME)) ELSE '''''''' END AS O_BRANCH_NAME
,CASE WHEN RDV_BDV.LASTNAME IS NOT NULL THEN RDV_BDV.LASTNAME WHEN RTrim(LTrim(RDV_BDV.REP_LNAME)) IS NOT NULL THEN RTrim(LTrim(RDV_BDV.REP_LNAME)) ELSE '''''''' END AS O_LAST_NAME
,CASE WHEN RDV_BDV.FIRSTNAME IS NOT NULL THEN RDV_BDV.FIRSTNAME WHEN RTrim(LTrim(RDV_BDV.REP_FNAME)) IS NOT NULL THEN RTrim(LTrim(RDV_BDV.REP_FNAME)) ELSE '''''''' END AS O_FIRST_NAME
,CASE WHEN RDV_BDV.TEAMID IS NULL THEN GROUPID ELSE RDV_BDV.TEAMID END AS  O_TEAM_CODE
,CASE WHEN RDV_BDV.O_MASTER_CODE IS NULL THEN 0 ELSE 1 END AS O_DEPARTED_ADVISOR_IND
,CASE WHEN RDV_BDV.PRIMARY_ROLE = ''''Corporation'''' THEN ''''True'''' ELSE ''''False'''' END AS O_ISCORPORATION
,RDV_BDV.O_HK_HUB_PARTY_ROLE_ADVISOR AS HK_HUB_PARTY_ROLE_ADVISOR
,RDV_BDV.LINK_MASTER_CODE AS LINK_MASTER_CODE
,RDV_BDV.Advisor_fullname AS Advisor_fullname
,RDV_BDV.END_DATE AS END_DATE
,RDV_BDV.REASON AS REASON
,RDV_BDV.NEW_FIRM AS NEW_FIRM	
,RDV_BDV.NEW_FIRM_TYPE	AS NEW_FIRM_TYPE
,RDV_BDV.NEW_FIRM_BACK_OFFICE AS NEW_FIRM_BACK_OFFICE	
,RDV_BDV.PRESTIGE_STATUS AS PRESTIGE_STATUS
,RDV_BDV.TRANSITION_PERIOD_END_DATE AS TRANSITION_PERIOD_END_DATE
,RDV_BDV.DEAL_ASSESTS AS DEAL_ASSESTS	
,RDV_BDV.EXPECTED_ASSESTS AS EXPECTED_ASSESTS	
,RDV_BDV.PREVIOUS_FIRM AS PREVIOUS_FIRM	
,RDV_BDV.PREVIOUS_FIRM_TYPE AS PREVIOUS_FIRM_TYPE
,BUSINESS_RULES.UDF_CONV_BR_ALL_ADVISOR_001(RDV_BDV.BEGIN_DT,O_MD_START_DT) AS O_NEW_ADVISOR_IND
,BUSINESS_RULES.UDF_CONV_BR_ALL_ADVISOR_003(RDV_BDV.ADVISOR_BIRTH_DATE,O_MD_START_DT,O_ISCORPORATION)[''''o_AGE_SEGMENT''''] AS O_AGE_SEGMENT
,BUSINESS_RULES.UDF_CONV_BR_ALL_ADVISOR_003(RDV_BDV.ADVISOR_BIRTH_DATE,O_MD_START_DT,O_ISCORPORATION)[''''o_AGE_SEGMENT_ORD''''] AS O_AGE_SEGMENT_ORD
,RDV_BDV.PRIMARY_ROLE AS O_PRIMARY_ROLE
,RDV_BDV.BEGIN_DT AS BEGIN_DT
--,RDV_BDV.MD_ACTIVE_CERTS AS MD_ACTIVE_CERTS
FROM
( SELECT * FROM  
(
SELECT MAX(SAT_LINKCV.MD_EXTRACT_DT) AS SAT_LINKCV_MD_EXTRACT_DT,MAX(SAT_LINKCV.MD_SOURCE) AS SAT_LINKCV_MD_SOURCE,LINK.HK_HUB_PARTY_ROLE_ADVISOR AS O_HK_HUB_PARTY_ROLE_ADVISOR , LINK.MASTER_CODE AS LINK_MASTER_CODE FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE LINK
JOIN
(SELECT SAT_LINK.* FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE SAT_LINK
JOIN 
(SELECT * FROM  (SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_LINK ORDER BY MD_START_DT DESC) RN FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE WHERE MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')) CV WHERE CV.RN = 1) SAT_LINKCV
ON SAT_LINKCV.HK_LINK = SAT_LINK.HK_LINK WHERE SAT_LINK.MD_ACTIVE = ''''A'''' AND SAT_LINK.MD_SRC_SYSTEM = ''''IAS''''
)SAT_LINKCV
ON LINK.HK_LINK = SAT_LINKCV.HK_LINK

GROUP BY (LINK.MASTER_CODE, LINK.HK_HUB_PARTY_ROLE_ADVISOR)
)BDV1



LEFT JOIN

(
SELECT SAT_REGCV.*,HUB_REG.RR_CD AS O_RR_CD FROM (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.HUB_REGISTERED_REPRESENTATIVE WHERE (MD_SRC_SYSTEM = ''''IAS-COMMISSION''''  OR  MD_SRC_SYSTEM = ''''IAS_CERTS'''' ))HUB_REG 
JOIN
(SELECT SAT_REG.* FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_COMMISSION SAT_REG
JOIN 
(SELECT * FROM  (SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_HUB ORDER BY MD_START_DT DESC) RN FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_COMMISSION WHERE MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')) CV WHERE CV.RN = 1) SAT_REGCV
ON SAT_REGCV.HK_HUB = SAT_REG.HK_HUB WHERE SAT_REG.MD_ACTIVE = ''''A''''
)SAT_REGCV
ON HUB_REG.HK_HUB = SAT_REGCV.HK_HUB WHERE SAT_REGCV.LASTNAME IS NOT NULL AND SAT_REGCV.FIRSTNAME IS NOT NULL AND SAT_REGCV.ACTIVE = ''''1''''

) RDV1

ON (BDV1.LINK_MASTER_CODE = RDV1.MAINREPCODE OR BDV1.LINK_MASTER_CODE = RDV1.O_RR_CD)


LEFT JOIN


(SELECT VW_PARTY.* FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.VW_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH VW_PARTY
JOIN 
(SELECT * FROM  (SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_HUB_PARTY_ROLE_ADVISOR ORDER BY MD_START_DT DESC) RN FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.VW_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH WHERE MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')) CV WHERE CV.RN = 1) VW_PARTYCV
ON VW_PARTYCV.HK_HUB_PARTY_ROLE_ADVISOR = VW_PARTY.HK_HUB_PARTY_ROLE_ADVISOR WHERE VW_PARTY.MD_ACTIVE = ''''A''''
)BDV2


ON BDV1.LINK_MASTER_CODE = BDV2.MASTER_CODE

LEFT JOIN



(
SELECT SAT_REF_MONCV.*,REF_MON.REPID FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_RDV.REF_MONTHLY_MILESTONES REF_MON
JOIN
(SELECT SAT_REF_MON.* FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_RDV.SAT_REF_MONTHLY_MILESTONES_IAS SAT_REF_MON
JOIN 
(SELECT * FROM  (SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_HUB ORDER BY MD_START_DT DESC) RN FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_RDV.SAT_REF_MONTHLY_MILESTONES_IAS WHERE MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')) CV WHERE CV.RN = 1) SAT_REF_MONCV
ON SAT_REF_MONCV.HK_HUB = SAT_REF_MON.HK_HUB WHERE SAT_REF_MON.MD_ACTIVE = ''''A''''
)SAT_REF_MONCV
ON REF_MON.HK_HUB = SAT_REF_MONCV.HK_HUB
)RDV2_MON

ON BDV1.LINK_MASTER_CODE = RDV2_MON.REPID


LEFT JOIN 


(
SELECT REF_MAN.REPID FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_RDV.REF_MONTHLY_MILESTONES REF_MAN
JOIN
(SELECT SAT_REF_MAN.HK_HUB FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_RDV.SAT_REF_MONTHLY_MILESTONES_IAS SAT_REF_MAN
JOIN 
(SELECT * FROM  (SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_HUB ORDER BY MD_START_DT DESC) RN FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_RDV.SAT_REF_MONTHLY_MILESTONES_IAS WHERE MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')) CV WHERE CV.RN = 1) SAT_REF_MANCV
ON SAT_REF_MANCV.HK_HUB = SAT_REF_MAN.HK_HUB WHERE SAT_REF_MAN.MD_ACTIVE = ''''A''''
)SAT_REF_MANCV
ON REF_MAN.HK_HUB = SAT_REF_MANCV.HK_HUB
)RDV3_MAN

ON BDV1.LINK_MASTER_CODE = RDV3_MAN.REPID


LEFT JOIN

(
SELECT SAT_REPCV.TEAMID,SAT_REPCV.TEAMNAME,HUB_REP.RR_CD FROM (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.HUB_REGISTERED_REPRESENTATIVE WHERE MD_SRC_SYSTEM LIKE ''''%IAS%'''')HUB_REP 
JOIN
(SELECT SAT_REP.* FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_IAS_IAVM SAT_REP
JOIN 
(SELECT * FROM  (SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_HUB ORDER BY MD_START_DT DESC) RN FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_IAS_IAVM WHERE MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')) CV WHERE CV.RN = 1) SAT_REPCV
ON SAT_REPCV.HK_HUB = SAT_REP.HK_HUB 
)SAT_REPCV
ON HUB_REP.HK_HUB = SAT_REPCV.HK_HUB WHERE SAT_REPCV.MD_ACTIVE = ''''A''''

)RDV4

ON BDV1.LINK_MASTER_CODE = RDV4.RR_CD

LEFT JOIN

(
SELECT LINK_SER.MASTER_CODE AS O_MASTER_CODE ,SAT_SERCV.END_DATE,SAT_SERCV.REASON,SAT_SERCV.NEW_FIRM,SAT_SERCV.NEW_FIRM_TYPE,SAT_SERCV.NEW_FIRM_BACK_OFFICE,SAT_SERCV.PRESTIGE_STATUS FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_BDV.LINK_SERVICING_CODES LINK_SER
JOIN
(SELECT SAT_SER.* FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_BDV.SAT_LINK_SERVICING_CODES SAT_SER
JOIN 
(SELECT * FROM  (SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_LINK ORDER BY MD_START_DT DESC) RN FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_BDV.SAT_LINK_SERVICING_CODES WHERE MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')) CV WHERE CV.RN = 1) SAT_SERCV
ON SAT_SERCV.HK_LINK = SAT_SER.HK_LINK WHERE SAT_SER.MD_ACTIVE = ''''A''''
)SAT_SERCV
ON LINK_SER.HK_LINK = SAT_SERCV.HK_LINK

GROUP BY (LINK_SER.MASTER_CODE,SAT_SERCV.END_DATE,SAT_SERCV.REASON,SAT_SERCV.NEW_FIRM,SAT_SERCV.NEW_FIRM_TYPE,SAT_SERCV.NEW_FIRM_BACK_OFFICE,SAT_SERCV.PRESTIGE_STATUS)
)BDV3

ON BDV1.LINK_MASTER_CODE = BDV3.O_MASTER_CODE

LEFT JOIN

(
SELECT LINK_ADV.MASTER_CODE,SAT_ADVCV.ADVISOR_NAME,SAT_ADVCV.TRANSITION_PERIOD_END_DATE,SAT_ADVCV.DEAL_ASSESTS,SAT_ADVCV.EXPECTED_ASSESTS,SAT_ADVCV.PREVIOUS_FIRM,SAT_ADVCV.PREVIOUS_FIRM_TYPE FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_RDV.REF_NEW_ADVISOR LINK_ADV
JOIN
(SELECT SAT_ADV.* FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_RDV.SAT_REF_NEW_ADVISOR_IAPW SAT_ADV
JOIN 
(SELECT * FROM  (SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_HUB ORDER BY MD_START_DT DESC) RN FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_RDV.SAT_REF_NEW_ADVISOR_IAPW WHERE MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')) CV WHERE CV.RN = 1) SAT_ADVCV
ON SAT_ADVCV.HK_HUB = SAT_ADV.HK_HUB WHERE SAT_ADV.MD_ACTIVE = ''''A''''
)SAT_ADVCV
ON LINK_ADV.HK_HUB = SAT_ADVCV.HK_HUB

GROUP BY (LINK_ADV.MASTER_CODE,SAT_ADVCV.ADVISOR_NAME,SAT_ADVCV.TRANSITION_PERIOD_END_DATE,SAT_ADVCV.DEAL_ASSESTS,SAT_ADVCV.EXPECTED_ASSESTS,SAT_ADVCV.PREVIOUS_FIRM,SAT_ADVCV.PREVIOUS_FIRM_TYPE)
)RDV5

ON BDV1.LINK_MASTER_CODE = RDV5.MASTER_CODE

)RDV_BDV
)SAT_PARTY
GROUP BY (HK_HUB_PARTY_ROLE_ADVISOR,O_MD_START_DT,O_EXTRACT_DT,O_MD_CREATION_DT,O_MD_SOURCE,O_MD_src_system,LINK_MASTER_CODE,O_Company_Code,O_Company_Name,O_Regulatory_Organization_Name,O_Regulatory_Organization_Code,O_Dealer_Name,O_Regional_VP,O_BRANCH_CODE,O_BRANCH_NAME,O_TEAM_CODE,O_Team_Name,Advisor_fullname,O_FIRST_NAME,O_LAST_NAME,O_Status,O_province_code,O_departed_advisor_ind,END_DATE,REASON,NEW_FIRM,NEW_FIRM_TYPE,NEW_FIRM_BACK_OFFICE,PRESTIGE_STATUS,TRANSITION_PERIOD_END_DATE,DEAL_ASSESTS,EXPECTED_ASSESTS,PREVIOUS_FIRM,PREVIOUS_FIRM_TYPE,O_AGE_SEGMENT,O_AGE_SEGMENT_ORD)
              '';
INS_UPDATE :='' UPDATE DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH
SET
MD_HASHDIFF=SHA1(UPPER(CONCAT(COALESCE(TRIM(COMPANY_CODE),''''#NULL#'''') ,''''|'''',COALESCE(TRIM(COMPANY_NAME),''''#NULL#''''), ''''|'''',  COALESCE(TRIM(REGULATORY_ORGANIZATION_NAME),''''#NULL#''''),
''''|'''',COALESCE(TRIM(REGULATORY_ORGANIZATION_CODE),''''#NULL#''''),''''|'''',COALESCE(TRIM(DEALER_CODE),''''#NULL#''''),''''|'''',COALESCE(TRIM(DEALER_NAME),''''#NULL#''''),
''''|'''',COALESCE(TRIM(REGION_CODE),''''#NULL#''''),''''|'''',COALESCE(TRIM(REGION_NAME),''''#NULL#''''),''''|'''',COALESCE(TRIM(REGION_VP),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(BRANCHCODE),''''#NULL#''''),''''|'''',COALESCE(TRIM(BRANCHNAME),''''#NULL#''''),''''|'''',COALESCE(TRIM(to_varchar(TEAM_CODE)),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(TEAM_NAME),''''#NULL#''''),''''|'''',COALESCE(TRIM(ADVISOR_FULLNAME),''''#NULL#''''),''''|'''',COALESCE(TRIM(FIRSTNAME),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(LASTNAME),''''#NULL#''''),''''|'''',COALESCE(TRIM(ADVISOR_CORPORATION_NAME),''''#NULL#''''),''''|'''',COALESCE(TRIM(STATUS),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(GROUP_RSP_INDICATOR),''''#NULL#''''),''''|'''',COALESCE(TRIM(PROVINCE_CODE),''''#NULL#''''),''''|'''',COALESCE(TRIM(PROVINCE),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(to_varchar(ADVISOR_START_DATE)),''''#NULL#''''),''''|'''',COALESCE(TRIM(to_varchar(NEW_ADVISOR)),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(to_varchar(DEPARTED_ADVISOR_IND)),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(PRIMARY_ROLE),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(TO_VARCHAR(END_DATE)),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(REASON),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(NEW_FIRM),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(NEW_FIRM_TYPE),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(NEW_FIRM_BACK_OFFICE),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(PRESTIGE_STATUS),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(to_varchar(TRANSITION_PERIOD_END_DATE)),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(to_varchar(DEAL_ASSESTS)),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(to_varchar(EXPECTED_ASSESTS)),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(PREVIOUS_FIRM),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(PREVIOUS_FIRM_TYPE),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(AGE_SEGMENT),''''#NULL#'''')
,''''|'''',COALESCE(TRIM(AGE_SEGMENT_ORD),''''#NULL#'''')
--,''''|'''',COALESCE(TRIM(MD_ACTIVE_CERTS),''''#NULL#'''')
)))
Where MD_SRC_SYSTEM = ''''IAS'''';
'';

EXECUTE IMMEDIATE :INS_PRE_DEL;
EXECUTE IMMEDIATE :INS_INSERT;
EXECUTE IMMEDIATE :INS_UPDATE;

END
';


CREATE OR REPLACE PROCEDURE SHARED_BDV."SP_CONV_LOADBDV_RDV_HOLDINGS_TO_BDV_WT_SAT_PARTY_ROLE_ADVISOR_AUA_SEG_COMPUTE"("ENV" VARCHAR(1000), "I_DATA_START_DATE" VARCHAR(1000), "I_AUDIT_ID" VARCHAR(1000))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
INS_INSERT STRING;
INS_UPDATE STRING;
BEGIN
i_DATA_START_DATE :=CHAR(39)||i_DATA_START_DATE||CHAR(39);
INS_INSERT := ''
INSERT INTO DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ADVISOR_AUA_SEG_COMPUTE
(
HK_HUB
,MD_START_DT
,MD_CREATION_DT
,MD_CREATION_AUDIT_ID
,MD_SOURCE
,MD_SRC_SYSTEM
,MD_EXTRACT_DT
,ADVISOR_AUA_SEGMENT
,ADVISOR_AUA_SEGMENT_ORDER
--,SUSPENDED_IND
)
SELECT
SATPARTY_BDV.HK_HUB_PARTY_ROLE_ADVISOR
,TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')
,CURRENT_TIMESTAMP
,''''-1''''
,SATPARTY_BDV.O_MAX_MD_SOURCE
,SATPARTY_BDV.O_MAX_MD_SRC_SYSTEM
,SATPARTY_BDV.O_MAX_MD_EXTRACT_DT
,BUSINESS_RULES.UDF_CONV_BR_ALL_ADVISOR_AUA_SEGMENTATION_002(SATPARTY_BDV.O_ADVISOR_SUM_AUA)[''''o_ADVISOR_AUA_SEGMENT'''']
,BUSINESS_RULES.UDF_CONV_BR_ALL_ADVISOR_AUA_SEGMENTATION_002(SATPARTY_BDV.O_ADVISOR_SUM_AUA)[''''o_ADVISOR_AUA_SEGMENT_ORDER'''']
--,CASE WHEN SATPARTY_BDV.O_MAX_MD_ACTIVE=''''D'''' AND SATPARTY_BDV.O_ADVISOR_SUM_AUA !=0 THEN 1 ELSE 0 END
FROM
(
SELECT  SUM(CASE WHEN BDV.AUA IS NULL THEN 0 ELSE BDV.AUA END) AS O_ADVISOR_SUM_AUA
,MAX(BDV.MD_SOURCE) AS O_MAX_MD_SOURCE
,MAX(BDV.MD_SRC_SYSTEM) AS O_MAX_MD_SRC_SYSTEM
,MAX(BDV.MD_EXTRACT_DT) AS O_MAX_MD_EXTRACT_DT
--,MAX(BDV.MD_ACTIVE_CERTS)   AS O_MAX_MD_ACTIVE
,BDV.HK_HUB_PARTY_ROLE_ADVISOR AS HK_HUB_PARTY_ROLE_ADVISOR
FROM
( SELECT * FROM 
(
SELECT SAT_LINKCV.*, LINK.HK_HUB_PARTY_ROLE_ADVISOR, LINK.MASTER_CODE FROM
(SELECT SAT_LINK.* FROM DB_IAWT_''||ENV||''_DWH.HOLDINGS_BDV.SAT_LINK_INVESTMENT SAT_LINK
JOIN
(SELECT * FROM  (SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_LINK ORDER BY MD_START_DT DESC) RN FROM DB_IAWT_''||ENV||''_DWH.HOLDINGS_BDV.SAT_LINK_INVESTMENT WHERE MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')) CV WHERE CV.RN = 1) SAT_LINKCV
ON SAT_LINKCV.HK_LINK = SAT_LINK.HK_LINK WHERE SAT_LINK.MD_ACTIVE = ''''A''''
)SAT_LINKCV
JOIN
DB_IAWT_''||ENV||''_DWH.HOLDINGS_BDV.LINK_INVESTMENT LINK
ON LINK.HK_LINK = SAT_LINKCV.HK_LINK
) BDV1
LEFT JOIN
(SELECT SAT_PARTY.HK_HUB FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH SAT_PARTY
JOIN
(SELECT * FROM  (SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_HUB ORDER BY MD_START_DT DESC) RN FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH WHERE MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')) CV WHERE CV.RN = 1) SAT_PARTYCV
ON SAT_PARTYCV.HK_HUB = SAT_PARTY.HK_HUB WHERE SAT_PARTY.MD_ACTIVE = ''''A''''
) BDV2
ON BDV1.HK_HUB_PARTY_ROLE_ADVISOR = BDV2.HK_HUB
) BDV GROUP BY BDV.HK_HUB_PARTY_ROLE_ADVISOR
) SATPARTY_BDV
 '';

INS_UPDATE :='' UPDATE DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ADVISOR_AUA_SEG_COMPUTE
SET
MD_HASHDIFF=SHA1(
CONCAT(COALESCE(ADVISOR_AUA_SEGMENT , '''' #NULL#''''),''''|''''
,COALESCE(TO_VARCHAR(ADVISOR_AUA_SEGMENT_ORDER), '''' #NULL#''''), ''''|''''
--,COALESCE(TO_VARCHAR(SUSPENDED_IND), '''' #NULL#'''')
))
Where HK_HUB <> ''''0''''
'';
EXECUTE IMMEDIATE :INS_INSERT;
EXECUTE IMMEDIATE :INS_UPDATE;
END
';

CREATE OR REPLACE PROCEDURE SHARED_BDV."SP_CONV_LOADBDV_RDV_HOLDINGS_TO_BDV_WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_AUA_SEG_COMPUTE"("ENV" VARCHAR(1000), "I_DATA_START_DATE" VARCHAR(1000))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
INS_PRE_DEL STRING;
INS_INSERT STRING;
INS_UPDATE STRING;

BEGIN
i_DATA_START_DATE :=CHAR(39)||i_DATA_START_DATE||CHAR(39);
INS_PRE_DEL := ''DELETE FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_AUA_SEG_COMPUTE WHERE MD_SRC_SYSTEM = ''''IAS'''' '';
INS_INSERT := ''
INSERT INTO DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_AUA_SEG_COMPUTE (
HK_HUB	
,MD_START_DT		 	
,MD_CREATION_DT	
,MD_CREATION_AUDIT_ID
,MD_SOURCE	
,MD_SRC_SYSTEM	
,MD_EXTRACT_DT	
,CLIENT_AUA_SEGMENT	
,CLIENT_AUA_SEGMENT_ORDER )
SELECT 
	bdv.HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER	
	,TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')	
	,CURRENT_TIMESTAMP
	,CURRENT_TIMESTAMP
	,MAX(bdv2.MD_SOURCE)
	,MAX(bdv2.MD_SRC_SYSTEM)
	,MAX(bdv2.MD_EXTRACT_DT)
	,SUM(bdv2.AUA)
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENT_AUA_SEGMENTATION_002(SUM(bdv2.AUA))[''''o_CLIENT_AUA_SEGMENT_ORDER'''']
	FROM (
	SELECT *
			FROM DB_IAWT_''||ENV||''_DWH.HOLDINGS_BDV.SAT_LINK_INVESTMENT
			)bdv2
		JOIN (
		SELECT *
			FROM (
				SELECT *
					,ROW_NUMBER() OVER (
						PARTITION BY HK_LINK ORDER BY MD_START_DT DESC
						) RN
				FROM DB_IAWT_''||ENV||''_DWH.HOLDINGS_BDV.SAT_LINK_INVESTMENT
				) SATHUB
			WHERE SATHUB.RN = 1 AND SATHUB.MD_START_DT = TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
			) rdv ON rdv.HK_LINK = bdv2.HK_LINK
		JOIN DB_IAWT_''||ENV||''_DWH.HOLDINGS_BDV.LINK_INVESTMENT bdv ON bdv.HK_LINK = bdv2.HK_LINK
		WHERE bdv2.MD_ACTIVE = ''''A'''' AND bdv2.MD_SRC_SYSTEM = ''''IAS''''
		GROUP BY bdv.HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER
              '';
INS_UPDATE :='' UPDATE DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_AUA_SEG_COMPUTE
SET
	MD_HASHDIFF=
	SHA1(CONCAT(COALESCE(CLIENT_AUA_SEGMENT, ''''#NULL#''''), ''''|'''',COALESCE(TO_VARCHAR(CLIENT_AUA_SEGMENT_ORDER), ''''#NULL#'''')))
Where HK_HUB <> ''''0'''' AND MD_SRC_SYSTEM = ''''IAS'''';
'';

EXECUTE IMMEDIATE :INS_PRE_DEL;
EXECUTE IMMEDIATE :INS_INSERT;
EXECUTE IMMEDIATE :INS_UPDATE;

END
';

CREATE OR REPLACE PROCEDURE SHARED_BDV."SP_CONV_LOADBDV_RDV_UNIVERIS_SHARED_TO_WT_SATACCOUNTHOLDER_COMPUTE"("ENV" VARCHAR(1000), "I_DATA_START_DATE" VARCHAR(1000))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
INS_PRE_DEL STRING;
INS_INSERT STRING;
INS_UPDATE STRING;
BEGIN
i_DATA_START_DATE :=CHAR(39)||i_DATA_START_DATE||CHAR(39);
INS_PRE_DEL := ''DELETE FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_COMPUTE WHERE MD_SRC_SYSTEM = ''''IAS-UNIVERIS'''' '';
INS_INSERT := ''
INSERT INTO DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_COMPUTE (HK_HUB,MD_START_DT,MD_CREATION_DT,MD_SOURCE,MD_SRC_SYSTEM,MD_EXTRACT_DT,INCOME_LEVEL_1_SEGMENT,INCOME_LEVEL_1_SEGMENT_ORD,INCOME_LEVEL_2_SEGMENT,INCOME_LEVEL_2_SEGMENT_ORD,AGE_SEGMENT,AGE_SEGMENT_ORD,NEW_CLIENT_IND)
SELECT rdv.HK_HUB
	,TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')
	,CURRENT_TIMESTAMP
	,rdv.MD_SOURCE
	,rdv.MD_SRC_SYSTEM
	,rdv.MD_EXTRACT_DT
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_INCOME_SEGMENTATION_006(rdv.SALARY_DESC)[''''o_INCOME_SEGMENT'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_INCOME_SEGMENTATION_006(rdv.SALARY_DESC)[''''o_INCOME_SEGMENT_ORD'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_SALARY_SEGMENTATION_007(rdv.SALARY_DESC)[''''o_SALARY_SEGMENT'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_SALARY_SEGMENTATION_007(rdv.SALARY_DESC)[''''o_SALARY_SEGMENT_ORD'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_AGE_SEGMENTATION_008(rdv.IVR_PRIM_BDT, rdv.CORP_CD, rdv.MD_START_DT)[''''o_AGE_SEGMENT'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_AGE_SEGMENTATION_008(rdv.IVR_PRIM_BDT, rdv.CORP_CD, rdv.MD_START_DT)[''''o_AGE_SEGMENT_ORD'''']
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENTS_004(rdv.MD_START_DT, rdv.CREATE_DT)
FROM (
	SELECT *
	FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_PARTY_ROLE_ACCOUNT_HOLDER_IAS_UNIVERIS
	) rdv
	JOIN (
	SELECT *
	FROM (
		SELECT *
			,ROW_NUMBER() OVER (
				PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
				) RN
		FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_PARTY_ROLE_ACCOUNT_HOLDER_IAS_UNIVERIS lv
		) SATHUB
	WHERE SATHUB.RN = 1
	) lv ON lv.HK_HUB = rdv.HK_HUB
WHERE rdv.MD_ACTIVE = ''''A'''' AND lv.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
              '';
INS_UPDATE :=''UPDATE DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_COMPUTE
SET
MD_HASHDIFF=SHA1(
				CONCAT(	COALESCE(TO_VARCHAR(INCOME_AMT),''''#NULL#''''), ''''|'''',
				COALESCE(INCOME_LEVEL_1_SEGMENT,''''#NULL#''''), ''''|'''',
				COALESCE(TO_VARCHAR(INCOME_LEVEL_1_SEGMENT_ORD),''''#NULL#''''), ''''|'''',
				COALESCE(INCOME_LEVEL_2_SEGMENT,''''#NULL#''''), ''''|'''',
				COALESCE(TO_VARCHAR(INCOME_LEVEL_2_SEGMENT_ORD),''''#NULL#''''), ''''|'''',
				COALESCE(AGE_SEGMENT,''''#NULL#''''), ''''|'''',
				COALESCE(TO_VARCHAR(AGE_SEGMENT_ORD),''''#NULL#''''), ''''|'''',
				COALESCE(NEW_CLIENT_IND,''''#NULL#'''')
				))
Where HK_HUB <> ''''0'''' AND MD_SRC_SYSTEM = ''''IAS-UNIVERIS''''
'';
EXECUTE IMMEDIATE :INS_PRE_DEL;
EXECUTE IMMEDIATE :INS_INSERT;
EXECUTE IMMEDIATE :INS_UPDATE;
END
';

CREATE OR REPLACE PROCEDURE SHARED_BDV."SP_CONV_LOADBDV_RDV_UNIVERIS_HOLDINGS_TO_BDV_WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_AUA_SEG_COMPUTE"("ENV" VARCHAR(1000), "I_DATA_START_DATE" VARCHAR(1000))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
INS_PRE_DEL STRING;
INS_INSERT STRING;
INS_UPDATE STRING;

BEGIN
i_DATA_START_DATE :=CHAR(39)||i_DATA_START_DATE||CHAR(39);
INS_PRE_DEL := ''DELETE FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_AUA_SEG_COMPUTE WHERE MD_SRC_SYSTEM = ''''IAS-UNIVERIS'''' '';
INS_INSERT := ''
INSERT INTO DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_AUA_SEG_COMPUTE (
HK_HUB	
,MD_START_DT		 	
,MD_CREATION_DT	
,MD_CREATION_AUDIT_ID
,MD_SOURCE	
,MD_SRC_SYSTEM	
,MD_EXTRACT_DT	
,CLIENT_AUA_SEGMENT	
,CLIENT_AUA_SEGMENT_ORDER )
SELECT 
	bdv.HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER	
	,TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')	
	,CURRENT_TIMESTAMP
	,CURRENT_TIMESTAMP
	,MAX(bdv2.MD_SOURCE)
	,MAX(bdv2.MD_SRC_SYSTEM)
	,MAX(bdv2.MD_EXTRACT_DT)
	,SUM(bdv2.AUA)
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENT_AUA_SEGMENTATION_002(SUM(bdv2.AUA))[''''o_CLIENT_AUA_SEGMENT_ORDER'''']
	FROM (
	SELECT *
			FROM DB_IAWT_''||ENV||''_DWH.HOLDINGS_BDV.SAT_LINK_INVESTMENT
			)bdv2
		JOIN (
		SELECT *
			FROM (
				SELECT *
					,ROW_NUMBER() OVER (
						PARTITION BY HK_LINK ORDER BY MD_START_DT DESC
						) RN
				FROM DB_IAWT_''||ENV||''_DWH.HOLDINGS_BDV.SAT_LINK_INVESTMENT
				) SATHUB
			WHERE SATHUB.RN = 1 AND SATHUB.MD_START_DT = TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
			) rdv ON rdv.HK_LINK = bdv2.HK_LINK
		JOIN DB_IAWT_''||ENV||''_DWH.HOLDINGS_BDV.LINK_INVESTMENT bdv ON bdv.HK_LINK = bdv2.HK_LINK
		WHERE bdv2.MD_ACTIVE = ''''A'''' AND bdv2.MD_SRC_SYSTEM = ''''IAS-UNIVERIS''''
		GROUP BY bdv.HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER
              '';
INS_UPDATE :='' UPDATE DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_AUA_SEG_COMPUTE
SET
	MD_HASHDIFF=
	SHA1(CONCAT(COALESCE(CLIENT_AUA_SEGMENT, ''''#NULL#''''), ''''|'''',COALESCE(TO_VARCHAR(CLIENT_AUA_SEGMENT_ORDER), ''''#NULL#'''')))
Where HK_HUB <> ''''0'''' AND MD_SRC_SYSTEM = ''''IAS-UNIVERIS'''';
'';

EXECUTE IMMEDIATE :INS_PRE_DEL;
EXECUTE IMMEDIATE :INS_INSERT;
EXECUTE IMMEDIATE :INS_UPDATE;

END
';

CREATE OR REPLACE PROCEDURE SHARED_BDV."SP_CONV_LOADBDV_RDV_SAT_REGISTERED_REPRESENTATIVE_TO_BDV_WT_PARTY_ROLE_ADVISOR_COMPUTE_INVESTIA_UNIVERIS"("ENV" VARCHAR(1000), "DATA_START_DATE" VARCHAR(20))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
DEL_QUERY STRING;
INS_QUERY STRING;
UPD_QUERY STRING;
BEGIN
DATA_START_DATE :=CHAR(39)||DATA_START_DATE||CHAR(39);
DEL_QUERY := ''DELETE FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH WHERE MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS'''''';
INS_QUERY := ''INSERT INTO DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH
(MD_START_DT,
MD_EXTRACT_DT,
MD_CREATION_DT,
MD_SOURCE,
MD_SRC_SYSTEM,
MASTER_CODE,
COMPANY_CODE,
COMPANY_NAME,
REGULATORY_ORGANIZATION_NAME,
REGULATORY_ORGANIZATION_CODE,
DEALER_CODE,
DEALER_NAME,
REGION_CODE,
REGION_NAME,
REGION_VP,
BRANCHCODE,
BRANCHNAME,
TEAM_CODE,
TEAM_NAME,
ADVISOR_FULLNAME,
FIRSTNAME,
LASTNAME,
ADVISOR_CORPORATION_NAME,
STATUS,
GROUP_RSP_INDICATOR,
PROVINCE_CODE,
PROVINCE,
ADVISOR_START_DATE,
NEW_ADVISOR	)
(
WITH
  LV1 AS (
  SELECT
	HK_LINK AS LV1_HK_LINK,
	MAX(MD_START_DT) AS LV1_O_DATA_START_DATE
	FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE
	WHERE MD_START_DT <= TO_DATE(''||DATA_START_DATE||'',''''YYYY-MM-DD'''')
	GROUP BY HK_LINK
  ),
  JNR_LinkShare AS (
  SELECT
	B.COM_TYPE 					AS 	COM_TYPE,
	B.COMMISSIONPCT 			AS 	COMMISSIONPCT,
	B.HK_LINK 					AS 	HK_LINK,
	B.IS_RESHARED 				AS 	IS_RESHARED,
	B.MD_ACTIVE 				AS 	MD_ACTIVE,
	B.MD_CREATION_AUDIT_ID 		AS 	MD_CREATION_AUDIT_ID,
	B.MD_CREATION_DT 			AS 	MD_CREATION_DT,
	B.MD_EXTRACT_DT 			AS 	MD_EXTRACT_DT,
	B.MD_HASHDIFF 				AS 	MD_HASHDIFF,
	B.MD_SOURCE 				AS 	MD_SOURCE,
	B.MD_SRC_SYSTEM 			AS 	MD_SRC_SYSTEM,
	B.MD_START_DT 				AS 	MD_START_DT,
	B.PHYSICAL 					AS 	PHYSICAL,
	B.TOREPID 					AS 	TOREPID,
	A.LV1_HK_LINK 				AS 	LV1_HK_LINK,
	C.LV1_O_DATA_START_DATE 	AS 	LV1_O_START_DATE,
	D.HK_HUB_PARTY_ROLE_ADVISOR AS 	share_HK_HUB_PARTY_ROLE_ADVISOR,
	D.HK_LINK 					AS 	share_HK_LINK,
	D.MASTER_CODE 				AS 	share_MASTER_CODE
	FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE B
	JOIN LV1 A 
	ON B.HK_LINK = A.LV1_HK_LINK
	JOIN LV1 C 
	ON B.MD_START_DT = C.LV1_O_DATA_START_DATE
	JOIN
	DB_IAWT_''||ENV||''_DWH.SHARED_BDV.LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE D
	ON B.HK_LINK = D.HK_LINK
	WHERE 
	B.MD_ACTIVE=''''A'''' AND B.MD_SRC_SYSTEM=''''INVESTIA-UNIVERIS''''
  ),
  AGG_LINK_PARTY_RELATIONSHIP_COMM AS (
  SELECT 
	max(MD_EXTRACT_DT)							AS SAT_SHARE_MD_EXTRACT_DT,
	max(MD_SOURCE) 								AS SAT_SHARE_MD_SOURCE,
	SHARE_HK_HUB_PARTY_ROLE_ADVISOR 			AS SAT_SHARE_SHARE_HK_HUB_PARTY_ROLE_ADVISOR,
	SHARE_MASTER_CODE 							AS SAT_SHARE_SHARE_MASTER_CODE
	FROM JNR_LinkShare
	GROUP BY Sat_share_share_MASTER_CODE, Sat_share_share_HK_HUB_PARTY_ROLE_ADVISOR
  ),
  LV2 AS (
  SELECT
	HK_HUB AS LV2_HK_HUB,
	MAX(MD_START_DT) AS LV2_O_DATA_START_DATE
	FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_INVESTIA_UNIVERIS
	WHERE MD_START_DT <= TO_DATE(''||DATA_START_DATE||'',''''YYYY-MM-DD'''')
	GROUP BY HK_HUB
  ),
  JNR_SAT_MaxRecord_WITH_SAT_All AS (
   SELECT 
	B.BRN_CD 					AS 	SAT_BRN_CD,
	B.BRN_NAME 					AS 	SAT_BRN_NAME,
	B.BRN_SYSID 				AS 	SAT_BRN_SYSID,
	B.COMPANY_CD 				AS 	SAT_COMPANY_CD,
	B.COMPANY_NAME 				AS 	SAT_COMPANY_NAME,
	B.CREATE_DT 				AS 	SAT_CREATE_DT,
	B.DLR_CD 					AS 	SAT_DLR_CD,
	B.DLR_NAME_ENG 				AS 	SAT_DLR_NAME_ENG,
	B.DLR_SYSID 				AS 	SAT_DLR_SYSID,
	B.HK_HUB 					AS 	SAT_HK_HUB,
	B.MD_ACTIVE 				AS 	SAT_MD_ACTIVE,
	B.MD_CREATION_AUDIT_ID 		AS 	SAT_MD_CREATION_AUDIT_ID,
	B.MD_CREATION_DT 			AS 	SAT_MD_CREATION_DT,
	B.MD_EXTRACT_DT 			AS 	SAT_MD_EXTRACT_DT,
	B.MD_HASHDIFF 				AS 	SAT_MD_HASHDIFF,
	B.MD_SOURCE 				AS 	SAT_MD_SOURCE,
	B.MD_SRC_SYSTEM 			AS 	SAT_MD_SRC_SYSTEM,
	B.MD_START_DT 				AS 	SAT_MD_START_DT,
	B.PROV_CD 					AS 	SAT_PROV_CD,
	B.REGULATORY_ORG_CD 		AS 	SAT_REGULATORY_ORG_CD,
	B.REGULATORY_ORG_NAME 		AS 	SAT_REGULATORY_ORG_NAME,
	B.REP_CORP_NAME 			AS 	SAT_REP_CORP_NAME,
	B.REP_FNAME 				AS 	SAT_REP_FNAME,
	B.REP_GRP_RSP 				AS 	SAT_REP_GRP_RSP,
	B.REP_LNAME 				AS 	SAT_REP_LNAME,
	B.REP_ST_NAME 				AS 	SAT_REP_ST_NAME,
	B.REP_SYSID 				AS 	SAT_REP_SYSID,
	B.REP_TEAM_CD 				AS 	SAT_REP_TEAM_CD,
	B.REP_TEAM_NAME 			AS 	SAT_REP_TEAM_NAME,
	B.REP_TITLE_DESC 			AS 	SAT_REP_TITLE_DESC,
	B.RGN_CD 					AS 	SAT_RGN_CD,
	B.RGN_MGR 					AS 	SAT_RGN_MGR,
	B.RGN_NAME 					AS 	SAT_RGN_NAME,
	B.RGN_SYSID 				AS 	SAT_RGN_SYSID,
	B.TERMINATE_DT 				AS 	SAT_TERMINATE_DT,
	A.LV2_HK_HUB 				AS 	SAT_LV2_HK_HUB,
	C.LV2_O_DATA_START_DATE 	AS 	SAT_LV2_O_DATA_START_DATE
	FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_INVESTIA_UNIVERIS B
	JOIN LV2 A
	ON B.HK_HUB = A.LV2_HK_HUB
	JOIN LV2 C
	ON B.MD_START_DT = C.LV2_O_DATA_START_DATE
	WHERE B.MD_ACTIVE = ''''A''''
   ),
   JNR_HubWithSat AS (
   SELECT
	A.SAT_BRN_CD 					AS 	SAT_BRN_CD,
	A.SAT_BRN_NAME 					AS 	SAT_BRN_NAME,
	A.SAT_BRN_SYSID 				AS 	SAT_BRN_SYSID,
	A.SAT_COMPANY_CD 				AS 	SAT_COMPANY_CD,
	A.SAT_COMPANY_NAME 				AS 	SAT_COMPANY_NAME,
	A.SAT_CREATE_DT 				AS 	SAT_CREATE_DT,
	A.SAT_DLR_CD 					AS 	SAT_DLR_CD,
	A.SAT_DLR_NAME_ENG 				AS 	SAT_DLR_NAME_ENG,
	A.SAT_DLR_SYSID 				AS 	SAT_DLR_SYSID,
	A.SAT_HK_HUB 					AS 	SAT_HK_HUB,
	A.SAT_LV2_HK_HUB 				AS 	SAT_LV2_HK_HUB,
	A.SAT_MD_ACTIVE 				AS 	SAT_MD_ACTIVE,
	A.SAT_MD_CREATION_AUDIT_ID 		AS 	SAT_MD_CREATION_AUDIT_ID,
	A.SAT_MD_CREATION_DT 			AS 	SAT_MD_CREATION_DT,
	A.SAT_MD_EXTRACT_DT 			AS 	SAT_MD_EXTRACT_DT,
	A.SAT_MD_HASHDIFF 				AS 	SAT_MD_HASHDIFF,
	A.SAT_MD_SOURCE 				AS 	SAT_MD_SOURCE,
	A.SAT_MD_SRC_SYSTEM 			AS 	SAT_MD_SRC_SYSTEM,
	A.SAT_MD_START_DT 				AS 	SAT_MD_START_DT,
	A.SAT_LV2_O_DATA_START_DATE 	AS 	SAT_LV2_O_DATA_START_DATE,
	A.SAT_PROV_CD 					AS 	SAT_PROV_CD,
	A.SAT_REGULATORY_ORG_CD 		AS 	SAT_REGULATORY_ORG_CD,
	A.SAT_REGULATORY_ORG_NAME 		AS 	SAT_REGULATORY_ORG_NAME,
	A.SAT_REP_CORP_NAME 			AS 	SAT_REP_CORP_NAME,
	A.SAT_REP_FNAME 				AS 	SAT_REP_FNAME,
	A.SAT_REP_GRP_RSP 				AS 	SAT_REP_GRP_RSP,
	A.SAT_REP_LNAME 				AS 	SAT_REP_LNAME,
	A.SAT_REP_ST_NAME 				AS 	SAT_REP_ST_NAME,
	A.SAT_REP_SYSID 				AS 	SAT_REP_SYSID,
	A.SAT_REP_TEAM_CD 				AS 	SAT_REP_TEAM_CD,
	A.SAT_REP_TEAM_NAME 			AS 	SAT_REP_TEAM_NAME,
	A.SAT_REP_TITLE_DESC 			AS 	SAT_REP_TITLE_DESC,
	A.SAT_RGN_CD 					AS 	SAT_RGN_CD,
	A.SAT_RGN_MGR 					AS 	SAT_RGN_MGR,
	A.SAT_RGN_NAME 					AS 	SAT_RGN_NAME,
	A.SAT_RGN_SYSID 				AS 	SAT_RGN_SYSID,
	A.SAT_TERMINATE_DT 				AS 	SAT_TERMINATE_DT,
	B.HK_HUB 						AS 	HUB_HK_HUB,
	B.MD_CREATION_AUDIT_ID 			AS 	HUB_MD_CREATION_AUDIT_ID,
	B.MD_CREATION_DT 				AS 	HUB_MD_CREATION_DT,
	B.MD_EXTRACT_DT 				AS 	HUB_MD_EXTRACT_DT,
	B.MD_SOURCE 					AS 	HUB_MD_SOURCE,
	B.MD_SRC_SYSTEM 				AS 	HUB_MD_SRC_SYSTEM,
	B.RR_CD 						AS 	HUB_RR_CD
	FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.HUB_REGISTERED_REPRESENTATIVE B
	JOIN JNR_SAT_MAXRECORD_WITH_SAT_ALL A
	ON B.HK_HUB = A.SAT_HK_HUB
	WHERE B.MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS''''
	AND A.sat_REP_LNAME IS NOT NULL
	AND A.sat_REP_FNAME IS NOT NULL
	AND A.sat_MD_ACTIVE = ''''A''''
   ),
   JNR_LINKPARTYWITHRR AS (
   SELECT
	B.HUB_HK_HUB 							AS 	HUB_HK_HUB,
	B.HUB_MD_CREATION_AUDIT_ID AS 	HUB_MD_CREATION_AUDIT_ID,
	B.HUB_MD_CREATION_DT AS 	HUB_MD_CREATION_DT,
	B.HUB_MD_EXTRACT_DT AS 	HUB_MD_EXTRACT_DT,
	B.HUB_MD_SOURCE AS 	HUB_MD_SOURCE,
	B.HUB_MD_SRC_SYSTEM AS 	HUB_MD_SRC_SYSTEM,
	B.HUB_RR_CD AS 	HUB_RR_CD,
	B.SAT_BRN_CD AS 	SAT_BRN_CD,
	B.SAT_BRN_NAME AS 	SAT_BRN_NAME,
	B.SAT_BRN_SYSID AS 	SAT_BRN_SYSID,
	B.SAT_COMPANY_CD AS 	SAT_COMPANY_CD,
	B.SAT_COMPANY_NAME AS 	SAT_COMPANY_NAME,
	B.SAT_CREATE_DT AS 	SAT_CREATE_DT,
	B.SAT_DLR_CD AS 	SAT_DLR_CD,
	B.SAT_DLR_NAME_ENG AS 	SAT_DLR_NAME_ENG,
	B.SAT_DLR_SYSID AS 	SAT_DLR_SYSID,
	B.SAT_HK_HUB AS 	SAT_HK_HUB,
	B.SAT_LV2_HK_HUB AS 	SAT_LV2_HK_HUB,
	B.SAT_MD_ACTIVE AS 	SAT_MD_ACTIVE,
	B.SAT_MD_CREATION_AUDIT_ID AS 	SAT_MD_CREATION_AUDIT_ID,
	B.SAT_MD_CREATION_DT AS 	SAT_MD_CREATION_DT,
	B.SAT_MD_EXTRACT_DT AS 	SAT_MD_EXTRACT_DT,
	B.SAT_MD_HASHDIFF AS 	SAT_MD_HASHDIFF,
	B.SAT_MD_SOURCE AS 	SAT_MD_SOURCE,
	B.SAT_MD_SRC_SYSTEM AS 	SAT_MD_SRC_SYSTEM,
	B.SAT_MD_START_DT AS 	SAT_MD_START_DT,
	B.SAT_LV2_O_DATA_START_DATE AS 	SAT_LV2_O_DATA_START_DATE,
	B.SAT_PROV_CD AS 	SAT_PROV_CD,
	B.SAT_REGULATORY_ORG_CD AS 	SAT_REGULATORY_ORG_CD,
	B.SAT_REGULATORY_ORG_NAME AS 	SAT_REGULATORY_ORG_NAME,
	B.SAT_REP_CORP_NAME AS 	SAT_REP_CORP_NAME,
	B.SAT_REP_FNAME AS 	SAT_REP_FNAME,
	B.SAT_REP_GRP_RSP AS 	SAT_REP_GRP_RSP,
	B.SAT_REP_LNAME AS 	SAT_REP_LNAME,
	B.SAT_REP_ST_NAME AS 	SAT_REP_ST_NAME,
	B.SAT_REP_SYSID AS 	SAT_REP_SYSID,
	B.SAT_REP_TEAM_CD AS 	SAT_REP_TEAM_CD,
	B.SAT_REP_TEAM_NAME AS 	SAT_REP_TEAM_NAME,
	B.SAT_REP_TITLE_DESC AS 	SAT_REP_TITLE_DESC,
	B.SAT_RGN_CD AS 	SAT_RGN_CD,
	B.SAT_RGN_MGR AS 	SAT_RGN_MGR,
	B.SAT_RGN_NAME AS 	SAT_RGN_NAME,
	B.SAT_RGN_SYSID 								AS 	SAT_RGN_SYSID,
	B.SAT_TERMINATE_DT 									AS 	SAT_TERMINATE_DT,
	A.SAT_SHARE_MD_EXTRACT_DT 							AS 	SAT_SHARE_MD_EXTRACT_DT,
	A.SAT_SHARE_MD_SOURCE 								AS 	SAT_SHARE_MD_SOURCE,
	A.SAT_SHARE_SHARE_HK_HUB_PARTY_ROLE_ADVISOR 		AS 	SAT_SHARE_SHARE_HK_HUB_PARTY_ROLE_ADVISOR,
	A.SAT_SHARE_SHARE_MASTER_CODE 						AS 	SAT_SHARE_SHARE_MASTER_CODE
	FROM JNR_HubWithSat B
	JOIN AGG_LINK_PARTY_RELATIONSHIP_COMM A
	ON A.SAT_SHARE_SHARE_MASTER_CODE = B.HUB_RR_CD
   ),
   LV3 AS (
  SELECT
	HK_HUB AS LV3_HK_HUB,
	MAX(MD_START_DT) AS LV3_O_PROV_MAX_START_DT
	FROM DB_IAWT_DEV_DWH.SHARED_RDV.SAT_REF_PROVINCE
	WHERE MD_START_DT <= TO_DATE(''||DATA_START_DATE||'',''''YYYY-MM-DD'''')
	GROUP BY HK_HUB
  ),
  JNR_SATPROVREGWITHDATEEXTRACT AS (
  SELECT
	B.HK_HUB AS sat_HK_HUB,
	B.MD_ACTIVE AS sat_MD_ACTIVE,
	B.MD_CREATION_AUDIT_ID AS sat_MD_CREATION_AUDIT_ID,
	B.MD_CREATION_DT AS sat_MD_CREATION_DT,
	B.MD_EXTRACT_DT AS sat_MD_EXTRACT_DT,
	B.MD_HASHDIFF AS sat_MD_HASHDIFF,
	B.MD_SOURCE AS sat_MD_SOURCE,
	B.MD_SRC_SYSTEM AS sat_MD_SRC_SYSTEM,
	B.MD_START_DT AS sat_MD_START_DT,
	B.PROV_DESC AS sat_PROV_DESC,
	C.LV3_HK_HUB AS LV3_HK_HUB,
	A.LV3_O_PROV_MAX_START_DT	 AS LV3_O_PROV_MAX_START_DT
	FROM DB_IAWT_DEV_DWH.SHARED_RDV.SAT_REF_PROVINCE B
	JOIN LV3 A
	ON B.MD_START_DT = A.LV3_O_PROV_MAX_START_DT
	JOIN LV3 C
	ON B.HK_HUB = C.LV3_HK_HUB
  ),
  JNR_HUBWITHSATFORPROVINCE AS (
  SELECT 
	LV3_HK_HUB AS SATPRV_HK_HUB,
	LV3_O_PROV_MAX_START_DT AS satprv_o_PROV_MAX_START_DT,
	SAT_HK_HUB AS SATPRV_SAT_HK_HUB,
	SAT_MD_ACTIVE AS SATPRV_SAT_MD_ACTIVE,
	SAT_MD_CREATION_AUDIT_ID AS SATPRV_SAT_MD_CREATION_AUDIT_ID,
	SAT_MD_CREATION_DT AS SATPRV_SAT_MD_CREATION_DT,
	SAT_MD_EXTRACT_DT AS SATPRV_SAT_MD_EXTRACT_DT,
	SAT_MD_HASHDIFF AS SATPRV_SAT_MD_HASHDIFF,
	SAT_MD_SOURCE AS SATPRV_SAT_MD_SOURCE,
	SAT_MD_SRC_SYSTEM AS SATPRV_SAT_MD_SRC_SYSTEM,
	SAT_MD_START_DT AS SATPRV_SAT_MD_START_DT,
	SAT_PROV_DESC AS SATPRV_SAT_PROV_DESC,
	HK_HUB AS HUBPRV_HK_HUB,
	PROV_CD AS HUBPRV_PROV_CD
	FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.REF_PROVINCE B
	JOIN JNR_SATPROVREGWITHDATEEXTRACT A 
	ON B.HK_HUB = A.LV3_HK_HUB
  ),
  JNR_PRV_WITH_MAINLINE AS (
   SELECT 
	TO_DATE(''||DATA_START_DATE||'',''''YYYY-MM-DD'''') AS O_MD_START_DT,
	TO_DATE(TO_CHAR(SAT_SHARE_MD_EXTRACT_DT,''''YYYY-MM-DD''''),''''YYYY-MM-DD'''')  AS o_MD_EXTRACT_DT,
	CURRENT_TIMESTAMP AS o_MD_CREATION_DT,
	B.SAT_SHARE_MD_SOURCE AS O_MAX_MD_SOURCE,
	''''INVESTIA-UNIVERIS'''' as o_MD_SRC_SYSTEM,
	B.SAT_SHARE_SHARE_MASTER_CODE AS SAT_SHARE_SHARE_MASTER_CODE,
	B.SAT_COMPANY_CD AS SAT_COMPANY_CD,
	B.SAT_REGULATORY_ORG_NAME AS SAT_REGULATORY_ORG_NAME,
	B.SAT_REGULATORY_ORG_CD AS SAT_REGULATORY_ORG_CD,
	B.SAT_DLR_CD AS SAT_DLR_CD,
	B.SAT_DLR_NAME_ENG AS SAT_DLR_NAME_ENG,
	B.SAT_RGN_CD AS SAT_RGN_CD,
	B.SAT_RGN_NAME AS SAT_RGN_NAME,
	CASE WHEN B.SAT_RGN_MGR IS NULL THEN ''''Non affiliated to RVPs'''' ELSE B.SAT_RGN_MGR END AS o_RVP,
	B.SAT_BRN_CD AS SAT_BRN_CD,
	B.SAT_BRN_NAME AS SAT_BRN_NAME,
	B.SAT_REP_TEAM_CD AS SAT_REP_TEAM_CD,
	B.SAT_REP_TEAM_NAME AS SAT_REP_TEAM_NAME,
	CONCAT(CASE WHEN B.SAT_REP_LNAME IS NULL THEN '''''''' ELSE B.SAT_REP_LNAME END , '''','''',CASE WHEN B.SAT_REP_FNAME IS NULL THEN '''''''' ELSE B.SAT_REP_FNAME END, ''''('''',B.SAT_SHARE_SHARE_MASTER_CODE, '''')'''') AS ADVISORFULLNAME,
	B.SAT_REP_FNAME AS SAT_REP_FNAME,
	B.SAT_REP_LNAME AS SAT_REP_LNAME,
	B.SAT_COMPANY_NAME AS SAT_COMPANY_NAME,
	B.SAT_REP_ST_NAME AS SAT_REP_ST_NAME,
	B.SAT_REP_GRP_RSP AS SAT_REP_GRP_RSP,
	CASE WHEN B.SAT_PROV_CD IS NULL THEN ''''N/A'''' ELSE CASE WHEN B.SAT_PROV_CD = ''''#N/A'''' THEN ''''N/A'''' ELSE B.SAT_PROV_CD END END AS O_PROVINCE_CODE,
	A.SATPRV_SAT_PROV_DESC AS SATPRV_SAT_PROV_DESC,
	TO_DATE(TO_CHAR(B.sat_CREATE_DT,''''YYYY-MM-DD''''),''''YYYY-MM-DD'''') AS O_CREATE_DT
	FROM JNR_LINKPARTYWITHRR B 
	JOIN JNR_HUBWITHSATFORPROVINCE A
	ON B.SAT_PROV_CD = A.HUBPRV_PROV_CD
	)
	SELECT
	O_MD_START_DT 							AS 	MD_START_DT,
	O_MD_EXTRACT_DT 						AS 	MD_EXTRACT_DT,
	O_MD_CREATION_DT 						AS 	MD_CREATION_DT,
	O_MAX_MD_SOURCE 						AS 	MD_SOURCE,
	O_MD_SRC_SYSTEM 						AS 	MD_SRC_SYSTEM,
	SAT_SHARE_SHARE_MASTER_CODE 			AS 	MASTER_CODE,
	SAT_COMPANY_CD 							AS 	COMPANY_CODE,
	SAT_COMPANY_NAME 						AS 	COMPANY_NAME,
	SAT_REGULATORY_ORG_NAME 				AS 	REGULATORY_ORGANIZATION_NAME,
	SAT_REGULATORY_ORG_CD 					AS 	REGULATORY_ORGANIZATION_CODE,
	SAT_DLR_CD 								AS 	DEALER_CODE,
	SAT_DLR_NAME_ENG 						AS 	DEALER_NAME,
	SAT_RGN_CD 								AS 	REGION_CODE,
	SAT_RGN_NAME 							AS 	REGION_NAME,
	O_RVP 									AS 	REGION_VP,
	SAT_BRN_CD 								AS 	BRANCHCODE,
	SAT_BRN_NAME 							AS 	BRANCHNAME,
	SAT_REP_TEAM_CD 						AS 	TEAM_CODE,
	SAT_REP_TEAM_NAME 						AS 	TEAM_NAME,
	ADVISORFULLNAME 						AS 	ADVISOR_FULLNAME,
	SAT_REP_FNAME 							AS 	FIRSTNAME,
	SAT_REP_LNAME 							AS 	LASTNAME,
	SAT_COMPANY_NAME 						AS 	ADVISOR_CORPORATION_NAME,
	SAT_REP_ST_NAME 						AS 	STATUS,
	SAT_REP_GRP_RSP 						AS 	GROUP_RSP_INDICATOR,
	O_PROVINCE_CODE 						AS 	PROVINCE_CODE,
	SATPRV_SAT_PROV_DESC 					AS 	PROVINCE,
	O_CREATE_DT 							AS 	CADVISOR_START_DATE,
	BUSINESS_RULES.UDF_CONV_BR_ALL_ADVISOR_001(o_CREATE_DT,O_MD_START_DT) AS NEW_ADVISOR_IND
	FROM JNR_PRV_WITH_MAINLINE)'';
UPD_QUERY := ''UPDATE DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_PARTY_ROLE_ADVISOR_COMPUTE_IAS_WEALTH
SET
MD_HASHDIFF=SHA1(UPPER(CONCAT(COALESCE(TRIM(COMPANY_CODE),''''NULL'''') ,''''|'''',COALESCE(TRIM(COMPANY_NAME),''''NULL''''), ''''|'''',  COALESCE(TRIM(REGULATORY_ORGANIZATION_NAME),''''NULL''''),
''''|'''',  COALESCE(TRIM(REGULATORY_ORGANIZATION_CODE),''''NULL''''),''''|'''',COALESCE(TRIM(DEALER_CODE),''''NULL''''),''''|'''',COALESCE(TRIM(DEALER_NAME),''''NULL''''),
''''|'''',COALESCE(TRIM(REGION_CODE),''''NULL''''),''''|'''',COALESCE(TRIM(REGION_NAME),''''NULL''''),''''|'''',COALESCE(TRIM(REGION_VP),''''NULL'''')
,''''|'''',COALESCE(TRIM(BRANCHCODE),''''NULL''''),''''|'''',COALESCE(TRIM(BRANCHNAME),''''NULL''''),''''|'''',COALESCE(TRIM(to_varchar(TEAM_CODE)),''''NULL'''')
,''''|'''',COALESCE(TRIM(TEAM_NAME),''''NULL''''),''''|'''',COALESCE(TRIM(ADVISOR_FULLNAME),''''NULL''''),''''|'''',COALESCE(TRIM(FIRSTNAME),''''NULL'''')
,''''|'''',COALESCE(TRIM(LASTNAME),''''NULL''''),''''|'''',COALESCE(TRIM(ADVISOR_CORPORATION_NAME),''''NULL''''),''''|'''',COALESCE(TRIM(STATUS),''''NULL'''')
,''''|'''',COALESCE(TRIM(GROUP_RSP_INDICATOR),''''NULL''''),''''|'''',COALESCE(TRIM(PROVINCE_CODE),''''NULL''''),''''|'''',COALESCE(TRIM(PROVINCE),''''NULL'''')
,''''|'''',COALESCE(TRIM(to_varchar(ADVISOR_START_DATE)),''''NULL''''),''''|'''',COALESCE(TRIM(to_varchar(NEW_ADVISOR)),''''NULL'''')
)))
Where MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS'''''';
EXECUTE IMMEDIATE :DEL_QUERY;
EXECUTE IMMEDIATE :INS_QUERY;
EXECUTE IMMEDIATE :UPD_QUERY;
END

';
CREATE OR REPLACE PROCEDURE SHARED_BDV."SP_CONV_LOADBDV_RDV_INVESTIA_UNIVERIS_SHARED_TO_WT_SATACCOUNTHOLDER_COMPUTE"("ENV" VARCHAR(1000), "I_DATA_START_DATE" VARCHAR(1000))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
INS_PRE_DEL STRING;
INS_INSERT STRING;
INS_UPDATE STRING;
BEGIN
i_DATA_START_DATE :=CHAR(39)||i_DATA_START_DATE||CHAR(39);
INS_PRE_DEL := ''DELETE FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_COMPUTE WHERE MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS'''' '';
INS_INSERT := ''
INSERT INTO DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_COMPUTE (HK_HUB,MD_START_DT,MD_CREATION_DT,MD_SOURCE,MD_SRC_SYSTEM,MD_EXTRACT_DT,INCOME_LEVEL_1_SEGMENT,INCOME_LEVEL_1_SEGMENT_ORD,INCOME_LEVEL_2_SEGMENT,INCOME_LEVEL_2_SEGMENT_ORD,AGE_SEGMENT,AGE_SEGMENT_ORD,NEW_CLIENT_IND)
SELECT rdv.HK_HUB
	,TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')
	,CURRENT_TIMESTAMP
	,rdv.MD_SOURCE
	,rdv.MD_SRC_SYSTEM
	,rdv.MD_EXTRACT_DT
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_INCOME_SEGMENTATION_006(rdv.SALARY_DESC)[''''o_INCOME_SEGMENT'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_INCOME_SEGMENTATION_006(rdv.SALARY_DESC)[''''o_INCOME_SEGMENT_ORD'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_SALARY_SEGMENTATION_007(rdv.SALARY_DESC)[''''o_SALARY_SEGMENT'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_SALARY_SEGMENTATION_007(rdv.SALARY_DESC)[''''o_SALARY_SEGMENT_ORD'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_AGE_SEGMENTATION_008(rdv.IVR_PRIM_BDT, rdv.CORP_CD, rdv.MD_START_DT)[''''o_AGE_SEGMENT'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_CLIENTS_AGE_SEGMENTATION_008(rdv.IVR_PRIM_BDT, rdv.CORP_CD, rdv.MD_START_DT)[''''o_AGE_SEGMENT_ORD'''']
	,BUSINESS_RULES.UDF_CONV_BR_ALL_CLIENTS_004(rdv.MD_START_DT, rdv.CREATE_DT)
FROM (
	SELECT *
	FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_PARTY_ROLE_ACCOUNT_HOLDER_INVESTIA_UNIVERIS
	) rdv
	JOIN (
	SELECT *
	FROM (
		SELECT *
			,ROW_NUMBER() OVER (
				PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
				) RN
		FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_PARTY_ROLE_ACCOUNT_HOLDER_INVESTIA_UNIVERIS lv
		) SATHUB
	WHERE SATHUB.RN = 1
	) lv ON lv.HK_HUB = rdv.HK_HUB
WHERE rdv.MD_ACTIVE = ''''A'''' AND lv.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
              '';
INS_UPDATE :=''UPDATE DB_IAWT_''||ENV||''_DWH.SHARED_BDV.WT_SAT_PARTY_ROLE_ACCOUNT_HOLDER_COMPUTE
SET
MD_HASHDIFF=SHA1(
				CONCAT(	COALESCE(TO_VARCHAR(INCOME_AMT),''''#NULL#''''), ''''|'''',
				COALESCE(INCOME_LEVEL_1_SEGMENT,''''#NULL#''''), ''''|'''',
				COALESCE(TO_VARCHAR(INCOME_LEVEL_1_SEGMENT_ORD),''''#NULL#''''), ''''|'''',
				COALESCE(INCOME_LEVEL_2_SEGMENT,''''#NULL#''''), ''''|'''',
				COALESCE(TO_VARCHAR(INCOME_LEVEL_2_SEGMENT_ORD),''''#NULL#''''), ''''|'''',
				COALESCE(AGE_SEGMENT,''''#NULL#''''), ''''|'''',
				COALESCE(TO_VARCHAR(AGE_SEGMENT_ORD),''''#NULL#''''), ''''|'''',
				COALESCE(NEW_CLIENT_IND,''''#NULL#'''')
				))
Where HK_HUB <> ''''0'''' AND MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS''''
'';
EXECUTE IMMEDIATE :INS_PRE_DEL;
EXECUTE IMMEDIATE :INS_INSERT;
EXECUTE IMMEDIATE :INS_UPDATE;
END
';

--- Tools

CREATE OR REPLACE PROCEDURE tools."SP_CONV_LOADBDV_RDV_TRANSACTIONS_IAS_UNIVERIS_TO_BDV_WT_LINK_TRANSACTIONS_IAS_UNIVERIS"("ENV" VARCHAR(1000), "I_DATA_START_DATE" VARCHAR(1000))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
INS_PRE_DEL STRING;
INS_INSERT STRING;
INS_UPDATE STRING;

BEGIN
i_DATA_START_DATE :=CHAR(39)||i_DATA_START_DATE||CHAR(39);
INS_PRE_DEL := ''DELETE FROM DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_BDV.WT_LINK_FINANCIAL_TRANSACTION_UNIVERIS WHERE 1=1'';
INS_INSERT := ''
INSERT INTO DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_BDV.WT_LINK_FINANCIAL_TRANSACTION_UNIVERIS (
HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER
,HK_HUB_PARTY_ROLE_ADVISOR	
,HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES		
,HK_HUB_INVESTMENT_PRODUCT_TYPE	
,HK_HUB_CONTRACT	
,MD_START_DT	
,MD_CREATION_DT	
,MD_SOURCE		
,MD_SRC_SYSTEM		
,MD_EXTRACT_DT	
,TRANSACTION_ID		
,UNIVERIS_CLIENT_ID	
,MASTER_CODE	
,UNIVERIS_PLAN_ID	
,INVESTMENT_PRODUCT_ID		
,PLN_MNEM		
,TRADE_DATE	
,GROSS_AMOUNT	
,TRANSACTION_TYPE	
,ORD_TRANSACTION_TYPE	
,CASH_FLOW	
,CASH_FLOW_TYPE		
,ADMINISTRATORY_TYPE	
,DEPARTED_ADVISOR_IND		
,DEPARTED_ADVISOR_MASTER_CODE )
SELECT
	bdv0.HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER	
	,bdv02.HK_HUB_PARTY_ROLE_ADVISOR	
	,bdv2.HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES	
	,rdv.HK_HUB_INVESTMENT_PRODUCT_TYPE	
	,rdv.HK_HUB_CONTRACT	
	,TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')
	,CURRENT_TIMESTAMP	
	,trdv.MD_SOURCE	
	,rdv.MD_SRC_SYSTEM	
	,trdv.MD_EXTRACT_DT	
	,rdv.TRANSACTION_ID	
	,rdv.UNIVERIS_CLIENT_ID	
	,bdv02.MASTER_CODE	
	,rdv.UNIVERIS_PLAN_ID
	,rdv.INVESTMENT_PRODUCT_ID	
	,bdv2.PLN_MNEM	
	,trdv.TRADE_DT	
	,trdv.TRX_GROSS* (CASE WHEN bdv02.COMMISSIONPCT IS NULL THEN 1 ELSE bdv02.COMMISSIONPCT/100 END)
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_TRANSACTION_TYPE_001(trdv.SPR_CTGY,trdv.TRX_MNEM_ENG)[''''o_TRANSACTION_TYPE'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_TRANSACTION_TYPE_001(trdv.SPR_CTGY,trdv.TRX_MNEM_ENG)[''''o_ORD_TRANSACTION_TYPE'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_CASH_FLOW_002(trdv.TRX_MNEM_ENG)
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_CASH_FLOW_003((trdv.TRX_MNEM_ENG),(trdv.TRX_GROSS*1))
	,bdv04.ADMINISTRATOR_TYPE	
	,CASE WHEN bdv07.REP_CODE IS NULL THEN 1 ELSE 0 END
	,bdv07.MASTER_CODE
	FROM (
		SELECT *
			FROM DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_RDV.SAT_LINK_FINANCIAL_TRANSACTION_RR_IAS_UNIVERIS WHERE MD_START_DT = TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD''''))trdv
		JOIN DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_RDV.LINK_FINANCIAL_TRANSACTION_RR rdv ON rdv.HK_LINK = trdv.HK_LINK
		LEFT JOIN
		(
			SELECT *
			FROM (
				SELECT rdv2.HK_HUB_CONTRACT,rdv2.HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER
				FROM (DB_IAWT_''||ENV||''_DWH.SHARED_RDV.LINK_INVESTMENT_CONTRACT_RR) rdv2
				JOIN DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_LINK_INVESTMENT_CONTRACT_IAS_UNIVERIS srdv4 ON srdv4.HK_LINK = rdv2.HK_LINK
			JOIN ( 
				SELECT *
				FROM (
					SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_HUB_CONTRACT ORDER BY MD_START_DT DESC) RN 
						FROM (SELECT * from DB_IAWT_''||ENV||''_DWH.SHARED_RDV.LINK_INVESTMENT_CONTRACT_RR rdv2 
							JOIN DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_LINK_INVESTMENT_CONTRACT_IAS_UNIVERIS srdv4 
				ON srdv4.HK_LINK = rdv2.HK_LINK)) SATHUB WHERE SATHUB.RN = 1 AND SATHUB.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				)SATHUB0 ON rdv2.HK_HUB_CONTRACT = SATHUB0.HK_HUB_CONTRACT AND srdv4.MD_START_DT = SATHUB0.MD_START_DT)
		)bdv0 ON bdv0.HK_HUB_CONTRACT = rdv.HK_HUB_CONTRACT  
		LEFT JOIN
		(
			SELECT srdv5.RR_CD, srdv5.HK_HUB,srdv3.MD_ACTIVE
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_IAS_UNIVERIS) srdv3
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
							) RN1
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_IAS_UNIVERIS) SATHUB1
				WHERE SATHUB1.RN1 = 1 AND SATHUB1.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				) rdv2lv ON rdv2lv.HK_HUB = srdv3.HK_HUB
			JOIN DB_IAWT_''||ENV||''_DWH.SHARED_RDV.HUB_REGISTERED_REPRESENTATIVE srdv5 ON srdv5.HK_HUB = srdv3.HK_HUB
			WHERE REGEXP_INSTR( srdv5.MD_SRC_SYSTEM, ''''IAS'''' )= TRUE
		)bdv01 ON trdv.REP_CD = bdv01.RR_CD
		LEFT JOIN
		(
			SELECT bdv.HK_HUB_REGISTERED_REPRESENTATIVE, bdv.HK_HUB_PARTY_ROLE_ADVISOR, bdv.MASTER_CODE, bdv3.COMMISSIONPCT
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE
				) bdv3
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_LINK ORDER BY MD_START_DT DESC
							) RN2
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE
					) SATHUB2
				WHERE SATHUB2.RN2 = 1 AND SATHUB2.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				) ssbdv4 ON ssbdv4.HK_LINK = bdv3.HK_LINK
			JOIN DB_IAWT_''||ENV||''_DWH.SHARED_BDV.LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE bdv ON bdv.HK_LINK =bdv3.HK_LINK WHERE ssbdv4.MD_ACTIVE = ''''A'''' AND ssbdv4.MD_SRC_SYSTEM = ''''IAS''''
		)bdv02	ON bdv01.HK_HUB = bdv02.HK_HUB_REGISTERED_REPRESENTATIVE
		LEFT JOIN
		(
			SELECT srdv.ADMINISTRATOR_TYPE,srdv.HK_HUB,srdv.MD_ACTIVE
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_CONTRACT_IAS_UNIVERIS) srdv
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
							) RN3
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_CONTRACT_IAS_UNIVERIS
					) SATHUB3
				WHERE SATHUB3.RN3 = 1 AND SATHUB3.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				) ssbdv5 ON ssbdv5.HK_HUB = srdv.HK_HUB WHERE ssbdv5.MD_ACTIVE = ''''A''''
		)bdv04 ON rdv.HK_HUB_CONTRACT = bdv04.HK_HUB
		LEFT JOIN
		(
			SELECT rdv3.*
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_INVESTMENT_PRODUCT_TYPE_IAS_UNIVERIS
				) rdv3
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
							) RN4
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_INVESTMENT_PRODUCT_TYPE_IAS_UNIVERIS
					) SATHUB4
				WHERE SATHUB4.RN4 = 1 AND SATHUB4.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				) ssbdv6 ON ssbdv6.HK_HUB = rdv3.HK_HUB WHERE ssbdv6.MD_ACTIVE = ''''A'''' 
		)bdv06 ON rdv.HK_HUB_INVESTMENT_PRODUCT_TYPE = bdv06.HK_HUB
		LEFT JOIN (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.LINK_INVESTMENT_CONTRACT) bdv2 ON bdv2.HK_HUB_CONTRACT = bdv0.HK_HUB_CONTRACT AND bdv02.HK_HUB_PARTY_ROLE_ADVISOR = bdv2.HK_HUB_PARTY_ROLE_ADVISOR
		LEFT JOIN
		(
			SELECT sbdv.REP_CODE, sbdv.MASTER_CODE
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_BDV.SAT_LINK_SERVICING_CODES
				) sbdv2
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_LINK ORDER BY MD_START_DT DESC
							) RN5
					FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_BDV.SAT_LINK_SERVICING_CODES
					) SATHUB5
				WHERE SATHUB5.RN5 = 1 AND SATHUB5.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				) ssbdv7 ON ssbdv7.HK_LINK = sbdv2.HK_LINK
			JOIN DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_BDV.LINK_SERVICING_CODES sbdv ON sbdv.HK_LINK = sbdv2.HK_LINK
			WHERE sbdv2.MD_ACTIVE = ''''A'''' AND sbdv2.REP_ROW_NUM = 1
			GROUP BY 1,2
		)bdv07 ON bdv01.RR_CD = bdv07.REP_CODE
		WHERE trdv.SPR_CTGY IN (''''PUR'''', ''''PAC'''', ''''RED'''', ''''AWD'''', ''''SWI'''', ''''SWO'''', ''''TIN'''', ''''TOT'''', ''''XIN'''', ''''XOT'''') AND bdv06.SYMBOL NOT IN (''''MRC001'''', ''''IAAFCCA'''', ''''INVCCA'''')	
		AND
		bdv01.MD_ACTIVE = ''''A''''
             '';
INS_UPDATE :='' UPDATE DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_BDV.WT_LINK_FINANCIAL_TRANSACTION_UNIVERIS
SET
	HK_LINK=
	SHA1(UPPER(CONCAT(COALESCE(TRIM(MD_SRC_SYSTEM), ''''#NULL#''''), ''''|'''' , 
	COALESCE(TRIM(TRANSACTION_ID), ''''#NULL#''''), ''''|'''' , 
	COALESCE(TRIM(UNIVERIS_CLIENT_ID), ''''#NULL#''''), ''''|'''' , 
	COALESCE(TRIM(MASTER_CODE), ''''#NULL#''''), ''''|'''' , 
	''''#NULL#'''', ''''|'''',  -- CONTRACT_ID
	COALESCE(TRIM(UNIVERIS_PLAN_ID), ''''#NULL#''''), ''''|'''',
	COALESCE(TRIM(INVESTMENT_PRODUCT_ID), ''''#NULL#''''), ''''|'''' ,  
	COALESCE(TRIM(PLN_MNEM),''''#NULL#''''), ''''|'''' , 
	''''#NULL#'''', ''''|'''', -- ACCOUNT_RAP_CODE
	''''#NULL#'''', ''''|'''' , -- RETAIL_PLAN
	''''#NULL#'''' -- ASC_1_RESP_PLAN_TYPES
	))),
	HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES = COALESCE(HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES,''''0''''),
	HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER= COALESCE(HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER,''''0''''),
	HK_HUB_PARTY_ROLE_ADVISOR= COALESCE(HK_HUB_PARTY_ROLE_ADVISOR,''''0''''),
	HK_HUB_INVESTMENT_PRODUCT_TYPE= COALESCE(HK_HUB_INVESTMENT_PRODUCT_TYPE,''''0''''),
	HK_HUB_CONTRACT= COALESCE(HK_HUB_CONTRACT,''''0'''')
Where 1=1;
'';
--EXECUTE IMMEDIATE :INS_PRE_DEL;
--EXECUTE IMMEDIATE :INS_INSERT;
--EXECUTE IMMEDIATE :INS_UPDATE;

RETURN INS_INSERT;

END
';

--- TRANSACTION BDV

CREATE OR REPLACE PROCEDURE TRANSACTIONS_BDV."SP_CONV_LOADBDV_RDV_TRANSACTIONS_IAS_UNIVERIS_TO_BDV_WT_LINK_TRANSACTIONS_IAS_UNIVERIS"("ENV" VARCHAR(1000), "I_DATA_START_DATE" VARCHAR(1000))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
INS_PRE_DEL STRING;
INS_INSERT STRING;
INS_UPDATE STRING;

BEGIN
i_DATA_START_DATE :=CHAR(39)||i_DATA_START_DATE||CHAR(39);
INS_PRE_DEL := ''DELETE FROM DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_BDV.WT_LINK_FINANCIAL_TRANSACTION_UNIVERIS WHERE 1=1'';
INS_INSERT := ''
INSERT INTO DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_BDV.WT_LINK_FINANCIAL_TRANSACTION_UNIVERIS (
HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER
,HK_HUB_PARTY_ROLE_ADVISOR	
,HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES		
,HK_HUB_INVESTMENT_PRODUCT_TYPE	
,HK_HUB_CONTRACT	
,MD_START_DT	
,MD_CREATION_DT	
,MD_SOURCE		
,MD_SRC_SYSTEM		
,MD_EXTRACT_DT	
,TRANSACTION_ID		
,UNIVERIS_CLIENT_ID	
,MASTER_CODE	
,UNIVERIS_PLAN_ID	
,INVESTMENT_PRODUCT_ID		
,PLN_MNEM		
,TRADE_DATE	
,GROSS_AMOUNT	
,TRANSACTION_TYPE	
,ORD_TRANSACTION_TYPE	
,CASH_FLOW	
,CASH_FLOW_TYPE		
,ADMINISTRATORY_TYPE	
,DEPARTED_ADVISOR_IND		
,DEPARTED_ADVISOR_MASTER_CODE )
SELECT
	bdv0.HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER	
	,bdv02.HK_HUB_PARTY_ROLE_ADVISOR	
	,bdv2.HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES	
	,rdv.HK_HUB_INVESTMENT_PRODUCT_TYPE	
	,rdv.HK_HUB_CONTRACT	
	,TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')
	,CURRENT_TIMESTAMP	
	,trdv.MD_SOURCE	
	,rdv.MD_SRC_SYSTEM	
	,trdv.MD_EXTRACT_DT	
	,rdv.TRANSACTION_ID	
	,rdv.UNIVERIS_CLIENT_ID	
	,bdv02.MASTER_CODE	
	,rdv.UNIVERIS_PLAN_ID
	,rdv.INVESTMENT_PRODUCT_ID	
	,bdv2.PLN_MNEM	
	,trdv.TRADE_DT	
	,trdv.TRX_GROSS* (CASE WHEN bdv02.COMMISSIONPCT IS NULL THEN 1 ELSE bdv02.COMMISSIONPCT/100 END)
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_TRANSACTION_TYPE_001(trdv.SPR_CTGY,trdv.TRX_MNEM_ENG)[''''o_TRANSACTION_TYPE'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_TRANSACTION_TYPE_001(trdv.SPR_CTGY,trdv.TRX_MNEM_ENG)[''''o_ORD_TRANSACTION_TYPE'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_CASH_FLOW_002(trdv.TRX_MNEM_ENG)
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_CASH_FLOW_003((trdv.TRX_MNEM_ENG),(trdv.TRX_GROSS*1))
	,bdv04.ADMINISTRATOR_TYPE	
	,CASE WHEN bdv07.REP_CODE IS NULL THEN 1 ELSE 0 END
	,bdv07.MASTER_CODE
	FROM (
		SELECT *
			FROM DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_RDV.SAT_LINK_FINANCIAL_TRANSACTION_RR_IAS_UNIVERIS WHERE MD_START_DT = TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD''''))trdv
		JOIN DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_RDV.LINK_FINANCIAL_TRANSACTION_RR rdv ON rdv.HK_LINK = trdv.HK_LINK
		LEFT JOIN
		(
			SELECT *
			FROM (
				SELECT rdv2.HK_HUB_CONTRACT,rdv2.HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER
				FROM (DB_IAWT_''||ENV||''_DWH.SHARED_RDV.LINK_INVESTMENT_CONTRACT_RR) rdv2
				JOIN DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_LINK_INVESTMENT_CONTRACT_IAS_UNIVERIS srdv4 ON srdv4.HK_LINK = rdv2.HK_LINK
			JOIN ( 
				SELECT *
				FROM (
					SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_HUB_CONTRACT ORDER BY MD_START_DT DESC) RN 
						FROM (SELECT * from DB_IAWT_''||ENV||''_DWH.SHARED_RDV.LINK_INVESTMENT_CONTRACT_RR rdv2 
							JOIN DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_LINK_INVESTMENT_CONTRACT_IAS_UNIVERIS srdv4 
				ON srdv4.HK_LINK = rdv2.HK_LINK)) SATHUB WHERE SATHUB.RN = 1 AND SATHUB.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				)SATHUB0 ON rdv2.HK_HUB_CONTRACT = SATHUB0.HK_HUB_CONTRACT AND srdv4.MD_START_DT = SATHUB0.MD_START_DT)
		)bdv0 ON bdv0.HK_HUB_CONTRACT = rdv.HK_HUB_CONTRACT  
		LEFT JOIN
		(
			SELECT srdv5.RR_CD, srdv5.HK_HUB,srdv3.MD_ACTIVE
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_IAS_UNIVERIS) srdv3
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
							) RN1
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_IAS_UNIVERIS) SATHUB1
				WHERE SATHUB1.RN1 = 1 AND SATHUB1.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				) rdv2lv ON rdv2lv.HK_HUB = srdv3.HK_HUB
			JOIN DB_IAWT_''||ENV||''_DWH.SHARED_RDV.HUB_REGISTERED_REPRESENTATIVE srdv5 ON srdv5.HK_HUB = srdv3.HK_HUB
			WHERE REGEXP_INSTR( srdv5.MD_SRC_SYSTEM, ''''IAS'''' )= TRUE
		)bdv01 ON trdv.REP_CD = bdv01.RR_CD
		LEFT JOIN
		(
			SELECT bdv.HK_HUB_REGISTERED_REPRESENTATIVE, bdv.HK_HUB_PARTY_ROLE_ADVISOR, bdv.MASTER_CODE, bdv3.COMMISSIONPCT
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE
				) bdv3
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_LINK ORDER BY MD_START_DT DESC
							) RN2
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE
					) SATHUB2
				WHERE SATHUB2.RN2 = 1 AND SATHUB2.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				) ssbdv4 ON ssbdv4.HK_LINK = bdv3.HK_LINK
			JOIN DB_IAWT_''||ENV||''_DWH.SHARED_BDV.LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE bdv ON bdv.HK_LINK =bdv3.HK_LINK WHERE ssbdv4.MD_ACTIVE = ''''A'''' AND ssbdv4.MD_SRC_SYSTEM = ''''IAS''''
		)bdv02	ON bdv01.HK_HUB = bdv02.HK_HUB_REGISTERED_REPRESENTATIVE
		LEFT JOIN
		(
			SELECT srdv.ADMINISTRATOR_TYPE,srdv.HK_HUB,srdv.MD_ACTIVE
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_CONTRACT_IAS_UNIVERIS) srdv
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
							) RN3
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_CONTRACT_IAS_UNIVERIS
					) SATHUB3
				WHERE SATHUB3.RN3 = 1 AND SATHUB3.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				) ssbdv5 ON ssbdv5.HK_HUB = srdv.HK_HUB WHERE ssbdv5.MD_ACTIVE = ''''A''''
		)bdv04 ON rdv.HK_HUB_CONTRACT = bdv04.HK_HUB
		LEFT JOIN
		(
			SELECT rdv3.*
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_INVESTMENT_PRODUCT_TYPE_IAS_UNIVERIS
				) rdv3
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
							) RN4
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_INVESTMENT_PRODUCT_TYPE_IAS_UNIVERIS
					) SATHUB4
				WHERE SATHUB4.RN4 = 1 AND SATHUB4.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				) ssbdv6 ON ssbdv6.HK_HUB = rdv3.HK_HUB WHERE ssbdv6.MD_ACTIVE = ''''A'''' 
		)bdv06 ON rdv.HK_HUB_INVESTMENT_PRODUCT_TYPE = bdv06.HK_HUB
		LEFT JOIN (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.LINK_INVESTMENT_CONTRACT) bdv2 ON bdv2.HK_HUB_CONTRACT = bdv0.HK_HUB_CONTRACT AND bdv02.HK_HUB_PARTY_ROLE_ADVISOR = bdv2.HK_HUB_PARTY_ROLE_ADVISOR
		LEFT JOIN
		(
			SELECT sbdv.REP_CODE, sbdv.MASTER_CODE
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_BDV.SAT_LINK_SERVICING_CODES
				) sbdv2
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_LINK ORDER BY MD_START_DT DESC
							) RN5
					FROM DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_BDV.SAT_LINK_SERVICING_CODES
					) SATHUB5
				WHERE SATHUB5.RN5 = 1 AND SATHUB5.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')
				) ssbdv7 ON ssbdv7.HK_LINK = sbdv2.HK_LINK
			JOIN DB_IAWT_''||ENV||''_DWH.STEWARDSHIP_BDV.LINK_SERVICING_CODES sbdv ON sbdv.HK_LINK = sbdv2.HK_LINK
			WHERE sbdv2.MD_ACTIVE = ''''A'''' AND sbdv2.REP_ROW_NUM = 1
			GROUP BY 1,2
		)bdv07 ON bdv01.RR_CD = bdv07.REP_CODE
		WHERE trdv.SPR_CTGY IN (''''PUR'''', ''''PAC'''', ''''RED'''', ''''AWD'''', ''''SWI'''', ''''SWO'''', ''''TIN'''', ''''TOT'''', ''''XIN'''', ''''XOT'''') AND bdv06.SYMBOL NOT IN (''''MRC001'''', ''''IAAFCCA'''', ''''INVCCA'''')	
		AND
		bdv01.MD_ACTIVE = ''''A''''
             '';
INS_UPDATE :='' UPDATE DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_BDV.WT_LINK_FINANCIAL_TRANSACTION_UNIVERIS
SET
	HK_LINK=
	SHA1(UPPER(CONCAT(COALESCE(TRIM(MD_SRC_SYSTEM), ''''#NULL#''''), ''''|'''' , 
	COALESCE(TRIM(TRANSACTION_ID), ''''#NULL#''''), ''''|'''' , 
	COALESCE(TRIM(UNIVERIS_CLIENT_ID), ''''#NULL#''''), ''''|'''' , 
	COALESCE(TRIM(MASTER_CODE), ''''#NULL#''''), ''''|'''' , 
	''''#NULL#'''', ''''|'''',  -- CONTRACT_ID
	COALESCE(TRIM(UNIVERIS_PLAN_ID), ''''#NULL#''''), ''''|'''',
	COALESCE(TRIM(INVESTMENT_PRODUCT_ID), ''''#NULL#''''), ''''|'''' ,  
	COALESCE(TRIM(PLN_MNEM),''''#NULL#''''), ''''|'''' , 
	''''#NULL#'''', ''''|'''', -- ACCOUNT_RAP_CODE
	''''#NULL#'''', ''''|'''' , -- RETAIL_PLAN
	''''#NULL#'''' -- ASC_1_RESP_PLAN_TYPES
	))),
	HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES = COALESCE(HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES,''''0''''),
	HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER= COALESCE(HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER,''''0''''),
	HK_HUB_PARTY_ROLE_ADVISOR= COALESCE(HK_HUB_PARTY_ROLE_ADVISOR,''''0''''),
	HK_HUB_INVESTMENT_PRODUCT_TYPE= COALESCE(HK_HUB_INVESTMENT_PRODUCT_TYPE,''''0''''),
	HK_HUB_CONTRACT= COALESCE(HK_HUB_CONTRACT,''''0'''')
Where 1=1;
'';

EXECUTE IMMEDIATE :INS_PRE_DEL;
EXECUTE IMMEDIATE :INS_INSERT;
EXECUTE IMMEDIATE :INS_UPDATE;


END
';

CREATE OR REPLACE PROCEDURE TRANSACTIONS_BDV."SP_CONV_LOADBDV_RDV_TRANSACTIONS_INVESTIA_UNIVERIS_TO_BDV_WT_LINK_FINANCIAL_TRANSACTION_INVESTIA_UNIVERIS"("ENV" VARCHAR(1000), "I_DATA_START_DATE" VARCHAR(1000))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
INS_PRE_DEL STRING;
INS_INSERT STRING;
INS_UPDATE STRING;

BEGIN
i_DATA_START_DATE :=CHAR(39)||i_DATA_START_DATE||CHAR(39);
INS_PRE_DEL := ''DELETE FROM DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_BDV.WT_LINK_FINANCIAL_TRANSACTION_INVESTIA_UNIVERIS WHERE 1=1'';
INS_INSERT := ''
INSERT INTO DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_BDV.WT_LINK_FINANCIAL_TRANSACTION_INVESTIA_UNIVERIS ( 	
HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER
,HK_HUB_PARTY_ROLE_ADVISOR	
,HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES	
,HK_HUB_INVESTMENT_PRODUCT_TYPE		
,HK_HUB_CONTRACT	
,MD_START_DT		
,MD_CREATION_DT	
,MD_SOURCE		
,MD_SRC_SYSTEM	
,MD_EXTRACT_DT	
,TRANSACTION_ID		
,UNIVERIS_CLIENT_ID	
,MASTER_CODE	
,UNIVERIS_PLAN_ID
,INVESTMENT_PRODUCT_ID	
,PLN_MNEM		
,TRADE_DATE		
,GROSS_AMOUNT		
,TRANSACTION_TYPE		
,ORD_TRANSACTION_TYPE		
,CASH_FLOW	
,CASH_FLOW_TYPE	
,ADMINISTRATORY_TYPE )
SELECT
	sbdv.HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER	
	,bdv02.HK_HUB_PARTY_ROLE_ADVISOR	
	,sbdv.HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES	
	,trdv.HK_HUB_INVESTMENT_PRODUCT_TYPE	
	,trdv.HK_HUB_CONTRACT	
	,TO_DATE(''||i_DATA_START_DATE||'',''''YYYY-MM-DD'''')	
	,CURRENT_TIMESTAMP
	,rdv3.MD_SOURCE	
	,trdv.MD_SRC_SYSTEM	
	,rdv3.MD_EXTRACT_DT	
	,trdv.TRANSACTION_ID	
	,trdv.UNIVERIS_CLIENT_ID
	,bdv02.MASTER_CODE	
	,trdv.UNIVERIS_PLAN_ID	
	,trdv.INVESTMENT_PRODUCT_ID	
	,sbdv.PLN_MNEM	
	,rdv3.TRADE_DT	
	,rdv3.TRX_GROSS* (CASE WHEN bdv02.COMMISSIONPCT IS NULL THEN 1 ELSE bdv02.COMMISSIONPCT/100 END)
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_TRANSACTION_TYPE_001(rdv3.SPR_CTGY,rdv3.TRX_MNEM_ENG)[''''o_TRANSACTION_TYPE'''']
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_TRANSACTION_TYPE_001(rdv3.SPR_CTGY,rdv3.TRX_MNEM_ENG)[''''o_TRANSACTION_TYPE'''']	
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_CASH_FLOW_002(rdv3.TRX_MNEM_ENG)
	,BUSINESS_RULES.UDF_CONV_BR_UNIVERIS_TRANSACTIONS_CASH_FLOW_003((rdv3.TRX_MNEM_ENG),(rdv3.TRX_GROSS* (CASE WHEN bdv02.COMMISSIONPCT IS NULL THEN 1 ELSE bdv02.COMMISSIONPCT/100 END)))
	,bdv04.ADMINISTRATOR_TYPE
	FROM (
		SELECT *
			FROM DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_RDV.SAT_LINK_FINANCIAL_TRANSACTION_RR_INVESTIA_UNIVERIS WHERE MD_START_DT = TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''')  AND MD_ACTIVE = ''''A'''' )rdv3
		JOIN (SELECT * FROM DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_RDV.LINK_FINANCIAL_TRANSACTION_RR WHERE  MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS'''')trdv 
		ON rdv3.HK_LINK = trdv.HK_LINK
		LEFT JOIN
		(
			SELECT rdv2.HK_HUB_CONTRACT, srdv3.MD_ACTIVE 
			FROM (
				SELECT *
				FROM (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.LINK_INVESTMENT_CONTRACT_RR WHERE MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS'''')) rdv2
				JOIN DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_LINK_INVESTMENT_CONTRACT_INVESTIA_UNIVERIS srdv3 ON srdv3.HK_LINK = rdv2.HK_LINK
			JOIN ( 
				SELECT *
				FROM (
					SELECT *, ROW_NUMBER() OVER(PARTITION BY HK_HUB_CONTRACT ORDER BY MD_START_DT DESC) RN 
						FROM (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.LINK_INVESTMENT_CONTRACT_RR rdv2 
							JOIN DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_LINK_INVESTMENT_CONTRACT_IAS_UNIVERIS srdv3 
				ON srdv3.HK_LINK = rdv2.HK_LINK WHERE rdv2.MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS'''')) SATHUB WHERE SATHUB.RN = 1 AND SATHUB.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''') 
				)SATHUB0 ON rdv2.HK_HUB_CONTRACT = SATHUB0.HK_HUB_CONTRACT AND srdv3.MD_START_DT = SATHUB0.MD_START_DT
		)bdv0 ON bdv0.HK_HUB_CONTRACT = trdv.HK_HUB_CONTRACT  
		LEFT JOIN
		(
			SELECT rdv.HK_HUB, rdv.RR_CD, srdv2.REP_SYSID, srdv2.MD_ACTIVE
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_INVESTIA_UNIVERIS) srdv2
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
							) RN1
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_REGISTERED_REPRESENTATIVE_INVESTIA_UNIVERIS) SATHUB1
				WHERE SATHUB1.RN1 = 1 AND SATHUB1.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''') 
				) rdv2lv ON rdv2lv.HK_HUB = srdv2.HK_HUB
			JOIN (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.HUB_REGISTERED_REPRESENTATIVE WHERE MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS'''')rdv ON rdv.HK_HUB = srdv2.HK_HUB WHERE srdv2.MD_ACTIVE = ''''A''''
		)bdv01 ON rdv3.REP_SYSID = bdv01.REP_SYSID
		LEFT JOIN
		(
			SELECT bdv.HK_HUB_REGISTERED_REPRESENTATIVE, bdv.HK_HUB_PARTY_ROLE_ADVISOR, bdv.MASTER_CODE, bdv2.COMMISSIONPCT
			FROM (
				SELECT *
				FROM (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE WHERE MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS''''
				))bdv2
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_LINK ORDER BY MD_START_DT DESC
							) RN2
					FROM (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.SAT_LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE WHERE MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS''''
					)) SATHUB2
				WHERE SATHUB2.RN2 = 1 AND SATHUB2.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''') 
				) ssbdv4 ON ssbdv4.HK_LINK = bdv2.HK_LINK 
			JOIN (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.LINK_PARTY_RELATIONSHIP_COMMISSION_SHARE WHERE MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS'''') bdv ON bdv.HK_LINK =bdv2.HK_LINK WHERE bdv2.MD_ACTIVE = ''''A''''
		)bdv02	ON bdv01.HK_HUB = bdv02.HK_HUB_REGISTERED_REPRESENTATIVE
		LEFT JOIN
		(
			SELECT srdv.HK_HUB,srdv.ADMINISTRATOR_TYPE
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_CONTRACT_INVESTIA_UNIVERIS) srdv
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
							) RN3
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_CONTRACT_INVESTIA_UNIVERIS
					) SATHUB3
				WHERE SATHUB3.RN3 = 1 AND SATHUB3.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''') 
				) ssbdv5 ON ssbdv5.HK_HUB = srdv.HK_HUB WHERE ssbdv5.MD_ACTIVE = ''''A''''
		)bdv04 ON trdv.HK_HUB_CONTRACT = bdv04.HK_HUB
		LEFT JOIN
		(
			SELECT rdv4.HK_HUB, rdv4.SYMBOL
			FROM (
				SELECT *
				FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_INVESTMENT_PRODUCT_TYPE_INVESTIA_UNIVERIS
				) rdv4
			JOIN (
				SELECT *
				FROM (
					SELECT *
						,ROW_NUMBER() OVER (
							PARTITION BY HK_HUB ORDER BY MD_START_DT DESC
							) RN4
					FROM DB_IAWT_''||ENV||''_DWH.SHARED_RDV.SAT_INVESTMENT_PRODUCT_TYPE_INVESTIA_UNIVERIS
					) SATHUB4
				WHERE SATHUB4.RN4 = 1 AND SATHUB4.MD_START_DT <= TO_DATE(''||i_DATA_START_DATE||'', ''''YYYY-MM-DD'''') 
				) ssbdv6 ON ssbdv6.HK_HUB = rdv4.HK_HUB WHERE ssbdv6.MD_ACTIVE = ''''A'''' 
		)bdv06 ON trdv.HK_HUB_INVESTMENT_PRODUCT_TYPE = bdv06.HK_HUB
		LEFT JOIN (SELECT * FROM DB_IAWT_''||ENV||''_DWH.SHARED_BDV.LINK_INVESTMENT_CONTRACT WHERE MD_SRC_SYSTEM = ''''INVESTIA-UNIVERIS'''') sbdv ON sbdv.HK_HUB_CONTRACT = trdv.HK_HUB_CONTRACT AND sbdv.HK_HUB_PARTY_ROLE_ADVISOR = bdv02.HK_HUB_PARTY_ROLE_ADVISOR
		WHERE rdv3.SPR_CTGY IN (''''PUR'''', ''''PAC'''', ''''RED'''', ''''AWD'''', ''''SWI'''', ''''SWO'''', ''''TIN'''', ''''TOT'''', ''''XIN'''', ''''XOT'''') AND bdv06.SYMBOL NOT IN (''''MRC001'''', ''''IAAFCCA'''', ''''INVCCA'''')	
		AND
		bdv0.MD_ACTIVE = ''''A''''        
             '';
INS_UPDATE :='' UPDATE DB_IAWT_''||ENV||''_DWH.TRANSACTIONS_BDV.WT_LINK_FINANCIAL_TRANSACTION_INVESTIA_UNIVERIS
SET 
	HK_LINK=
	SHA1(UPPER(CONCAT(COALESCE(TRIM(MD_SRC_SYSTEM), ''''#NULL#''''), ''''|'''' , 
	COALESCE(TRIM(TRANSACTION_ID), ''''#NULL#''''), ''''|'''' , 
	COALESCE(TRIM(UNIVERIS_CLIENT_ID), ''''#NULL#''''), ''''|'''' , 
	COALESCE(TRIM(MASTER_CODE), ''''#NULL#''''), ''''|'''' , 
	''''#NULL#'''', ''''|'''',  -- CONTRACT_ID
	COALESCE(TRIM(UNIVERIS_PLAN_ID), ''''#NULL#''''), ''''|'''',
	COALESCE(TRIM(INVESTMENT_PRODUCT_ID), ''''#NULL#''''), ''''|'''' ,  
	COALESCE(TRIM(PLN_MNEM),''''#NULL#''''), ''''|'''' , 
	''''#NULL#'''', ''''|'''', -- ACCOUNT_RAP_CODE
	''''#NULL#'''', ''''|'''' , -- RETAIL_PLAN
	''''#NULL#'''' -- ASC_1_RESP_PLAN_TYPES
	))),
	HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES = COALESCE(HK_HUB_INVESTMENT_SAVING_PROGRAM_TYPES,''''0''''),
	HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER= COALESCE(HK_HUB_PARTY_ROLE_ACCOUNT_HOLDER,''''0''''),
	HK_HUB_PARTY_ROLE_ADVISOR= COALESCE(HK_HUB_PARTY_ROLE_ADVISOR,''''0''''),
	HK_HUB_INVESTMENT_PRODUCT_TYPE= COALESCE(HK_HUB_INVESTMENT_PRODUCT_TYPE,''''0''''),
	HK_HUB_CONTRACT= COALESCE(HK_HUB_CONTRACT,''''0'''')
Where 1=1;
'';
EXECUTE IMMEDIATE :INS_PRE_DEL;
EXECUTE IMMEDIATE :INS_INSERT;
EXECUTE IMMEDIATE :INS_UPDATE;

END

';



